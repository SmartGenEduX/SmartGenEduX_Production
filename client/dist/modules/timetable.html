<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚è∞ Timetable Management System</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1300px; margin-top: 20px; }
        .card-header { background-color: #007bff; color: white; font-weight: bold; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 0.75rem; }
        .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 350px; border-radius: 0.5rem; }
        
        /* Timetable Grid Styles */
        .timetable-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr); /* 5 days + Time */
            border: 1px solid #dee2e6;
        }
        .grid-header, .grid-cell {
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-size: 0.85rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .grid-header { font-weight: bold; background-color: #e9ecef; }
        .time-cell { background-color: #f8f9fa; font-weight: 500; }
        .lesson-cell { cursor: pointer; transition: background-color 0.2s; }
        .lesson-cell:hover { background-color: #e0f7ff; }
        .break-cell { background-color: #f7e0e0; font-style: italic; color: #dc3545; }
        .conflict-cell { background-color: #ffcccc !important; border: 2px dashed #dc3545; }

        /* Configuration Styles */
        .period-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        .period-item:last-child { border-bottom: none; }
        .period-time { font-weight: bold; width: 120px; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-primary"><i class="bi bi-calendar-range-fill"></i> Timetable Manager & Version Control</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="timetableTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-view" type="button" role="tab"><i class="bi bi-grid-3x3-gap-fill"></i> View & Edit Schedule</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab"><i class="bi bi-clock-history"></i> Teacher Preferences</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab"><i class="bi bi-gear-fill"></i> Configuration Hub</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab"><i class="bi bi-shield-lock-fill"></i> Audit & Rollback</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="timetableTabContent">

            <!-- 1. View & Edit Schedule -->
            <div class="tab-pane fade show active" id="schedule-view" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Class Schedule Builder: <span id="currentVersionDisplay">Loading...</span></div>
                    <div class="card-body">
                        
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-3">
                                <label for="classSelector" class="form-label">Select Class</label>
                                <select class="form-select" id="classSelector" required>
                                    <option value="C1A">Class 1-A (Mock)</option>
                                    <option value="C2B">Class 2-B (Mock)</option>
                                    <option value="T9C">Class 9-C (Mock)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="academicYear" class="form-label">Academic Year</label>
                                <input type="text" class="form-control" id="academicYear" value="2024-25" required>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-primary me-2" id="refreshScheduleBtn"><i class="bi bi-arrow-clockwise"></i> Refresh Grid</button>
                            </div>
                            <div class="col-md-3 text-end d-flex align-items-end justify-content-end">
                                <button class="btn btn-info" id="exportScheduleBtn"><i class="bi bi-download"></i> Export PDF/HTML</button>
                            </div>
                        </div>

                        <!-- Timetable Grid Display -->
                        <div class="table-responsive">
                            <div id="timetableGridContainer" class="timetable-grid">
                                <!-- Grid populated dynamically here -->
                                <div class="grid-header">Time</div>
                                <div class="grid-header">Monday</div>
                                <div class="grid-header">Tuesday</div>
                                <div class="grid-header">Wednesday</div>
                                <div class="grid-header">Thursday</div>
                                <div class="grid-header">Friday</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Teacher Preferences -->
            <div class="tab-pane fade" id="preferences" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Teacher Unavailability & Preferences</div>
                    <div class="card-body">
                        <p class="alert alert-info">Use this to record periods when a teacher is unavailable (e.g., non-teaching duty, fixed meeting, personal appointments). This data is used by the system's conflict checking algorithm.</p>
                        
                        <form id="teacherPreferenceForm">
                            <div class="mb-3">
                                <label for="prefTeacherId" class="form-label">Select Teacher</label>
                                <select class="form-select" id="prefTeacherId" required>
                                    <option value="T001">Teacher Jane Doe (T001)</option>
                                    <option value="T002">Teacher John Smith (T002)</option>
                                </select>
                            </div>

                            <h5>Unavailable Periods (Maximum 5)</h5>
                            <div id="unavailablePeriodsContainer" class="p-3 border rounded mb-3">
                                <!-- Dynamic period inputs will be added here -->
                                <p class="text-muted text-center">Add unavailable time slots below.</p>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="addUnavailablePeriodBtn"><i class="bi bi-plus-circle"></i> Add Period</button>
                            <button type="submit" class="btn btn-primary w-100" id="savePreferencesBtn"><i class="bi bi-save"></i> Save Preferences</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 3. Configuration Hub -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-success">Configuration Hub: Periods, Wings & Holidays (Manager Access)</div>
                    <div class="card-body">
                        <form id="configForm">
                            <!-- Period Definition -->
                            <h5>1. Period Structure & Timings</h5>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered table-sm" id="periodConfigTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="periodConfigBody">
                                        <!-- Dynamic periods will be added here -->
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-sm btn-outline-success" id="addPeriodBtn"><i class="bi bi-plus-circle"></i> Add Period</button>
                            </div>

                            <!-- Wings & Holidays -->
                            <div class="row mb-4">
                                <h5>2. System Settings</h5>
                                <div class="col-md-6 mb-3">
                                    <label for="configWings" class="form-label">Defined Wings (Comma Separated)</label>
                                    <input type="text" class="form-control" id="configWings" value="Primary,Middle,Secondary" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="configHolidays" class="form-label">Holiday Dates (ISO Format, Comma Separated)</label>
                                    <textarea class="form-control" id="configHolidays" rows="3" placeholder="2024-12-25, 2025-01-01"></textarea>
                                    <div class="form-text">These dates are skipped during automatic schedule generation.</div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success w-100" id="saveConfigBtn"><i class="bi bi-save"></i> Save Configuration & Create New Version</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 4. Audit & Rollback -->
            <div class="tab-pane fade" id="audit" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-danger">Timetable Version Audit & Rollback (Manager/Admin Only)</div>
                    <div class="card-body">
                        <p class="alert alert-warning">Review historical configurations. Rolling back deletes the current schedule and restores the selected version's settings and entries.</p>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Version Name</th>
                                        <th>Date Created</th>
                                        <th>Created By</th>
                                        <th>Holiday Count</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="auditHistoryTableBody">
                                    <tr><td colspan="5" class="text-center">Loading audit history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <!-- Schedule Entry Modal (POST /schedule) -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Schedule Entry: <span id="modalDay"></span> - Period <span id="modalPeriod"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="scheduleEntryForm">
                    <div class="modal-body">
                        <input type="hidden" id="entryDayOfWeek">
                        <input type="hidden" id="entryPeriodNumber">
                        <input type="hidden" id="entryClassId">

                        <div class="mb-3">
                            <label for="entrySubjectId" class="form-label">Subject ID</label>
                            <input type="text" class="form-control" id="entrySubjectId" placeholder="e.g., MATH101" required>
                        </div>
                        <div class="mb-3">
                            <label for="entryTeacherProfileId" class="form-label">Teacher ID</label>
                            <input type="text" class="form-control" id="entryTeacherProfileId" placeholder="e.g., T001" required>
                        </div>
                        <div class="mb-3">
                            <label for="entryRoomNumber" class="form-label">Room Number</label>
                            <input type="text" class="form-control" id="entryRoomNumber" placeholder="e.g., A-205" required>
                        </div>
                        <div class="alert alert-warning d-none" id="conflictAlert">
                            Conflict check failed! Cannot schedule here.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success" id="saveScheduleEntryBtn">Save Entry</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = ''; 
        let configSettings = { periods: [], wings: [], holidayDates: [] };
        let currentSchedule = [];

        const dayMap = { 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday', 7: 'Sunday' };

        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => {
                area.style.display = 'none';
            }, 7000);
        }

        // --- Core Fetch Function ---
        async function apiFetch(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error.', 'danger');
                throw error;
            }
        }

        // --- 3. Configuration Hub Logic ---

        async function fetchConfig() {
            try {
                const data = await apiFetch('/config');
                configSettings = data.settings.settings || { periods: [], wings: ['Primary', 'Middle', 'Secondary'], holidayDates: [] };
                
                // Update version display
                document.getElementById('currentVersionDisplay').textContent = data.settings.version_name ? `Version: ${data.settings.version_name}` : 'Version: Draft';

                // Populate Period Table
                renderPeriodConfig(configSettings.periods);

                // Populate System Settings
                document.getElementById('configWings').value = configSettings.wings ? configSettings.wings.join(', ') : '';
                document.getElementById('configHolidays').value = configSettings.holidayDates ? configSettings.holidayDates.map(d => new Date(d).toISOString().split('T')[0]).join(', ') : '';

            } catch (error) {
                console.error('Failed to load configuration. Using defaults.');
                // Show notification only if it's not a 403 or simple not found error
            }
        }

        function renderPeriodConfig(periods) {
            const container = document.getElementById('periodConfigBody');
            container.innerHTML = '';
            
            periods.sort((a, b) => a.id - b.id);

            periods.forEach(p => {
                const row = container.insertRow();
                row.setAttribute('data-period-id', p.id);
                row.innerHTML = `
                    <td>${p.id}</td>
                    <td><input type="time" class="form-control form-control-sm" value="${p.startTime}" required></td>
                    <td><input type="time" class="form-control form-control-sm" value="${p.endTime}" required></td>
                    <td><input type="text" class="form-control form-control-sm" value="${p.name}" required></td>
                    <td>
                        <select class="form-select form-select-sm" required>
                            <option value="academic" ${p.type === 'academic' ? 'selected' : ''}>Academic</option>
                            <option value="break" ${p.type === 'break' ? 'selected' : ''}>Break</option>
                            <option value="assembly" ${p.type === 'assembly' ? 'selected' : ''}>Assembly</option>
                        </select>
                    </td>
                    <td><button type="button" class="btn btn-sm btn-danger delete-period-btn"><i class="bi bi-x-circle"></i></button></td>
                `;
            });
        }
        
        // Add new blank period row
        document.getElementById('addPeriodBtn').addEventListener('click', () => {
            const container = document.getElementById('periodConfigBody');
            const newId = container.rows.length + 1; // Simple incrementing ID
            const row = container.insertRow();
            row.setAttribute('data-period-id', newId);
            row.innerHTML = `
                <td>${newId}</td>
                <td><input type="time" class="form-control form-control-sm" value="09:00" required></td>
                <td><input type="time" class="form-control form-control-sm" value="09:40" required></td>
                <td><input type="text" class="form-control form-control-sm" value="New Period" required></td>
                <td>
                    <select class="form-select form-select-sm" required>
                        <option value="academic">Academic</option>
                        <option value="break">Break</option>
                        <option value="assembly">Assembly</option>
                    </select>
                </td>
                <td><button type="button" class="btn btn-sm btn-danger delete-period-btn"><i class="bi bi-x-circle"></i></button></td>
            `;
        });
        
        // Handle period deletion using delegation
        document.getElementById('periodConfigTable').addEventListener('click', (e) => {
            if (e.target.closest('.delete-period-btn')) {
                e.target.closest('tr').remove();
            }
        });

        // Handle Config Form Submission (PUT /config)
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true;

            const periods = [];
            const rows = document.getElementById('periodConfigBody').rows;
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                periods.push({
                    id: parseInt(cells[0].textContent),
                    startTime: cells[1].querySelector('input').value,
                    endTime: cells[2].querySelector('input').value,
                    name: cells[3].querySelector('input').value,
                    type: cells[4].querySelector('select').value,
                });
            }

            const holidayDates = document.getElementById('configHolidays').value.split(',').map(d => d.trim()).filter(d => d);

            const payload = {
                periods: periods,
                wings: document.getElementById('configWings').value.split(',').map(w => w.trim()).filter(w => w),
                defaultTemplateId: 'default_template_v1', // Mock static ID
                holidayDates: holidayDates
            };

            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message, 'success');
                fetchConfig(); // Refresh config display and version number
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });

        // --- 1. View & Edit Schedule Logic ---

        document.getElementById('refreshScheduleBtn').addEventListener('click', () => {
            const classId = document.getElementById('classSelector').value;
            if (classId) {
                fetchSchedule(classId);
            }
        });

        async function fetchSchedule(classId) {
            try {
                // 1. Fetch current schedule entries
                const data = await apiFetch(`/schedule/${classId}`);
                currentSchedule = data.schedule;

                // 2. Render the grid
                renderTimetableGrid(configSettings.periods, currentSchedule, classId);

            } catch (error) {
                showNotification('Could not load schedule. Check configuration and network.', 'danger');
                document.getElementById('timetableGridContainer').innerHTML = 'Failed to load schedule grid.';
            }
        }

        function renderTimetableGrid(periods, schedule, classId) {
            const container = document.getElementById('timetableGridContainer');
            container.innerHTML = '';
            
            // Set grid columns (Time + 5 days)
            container.style.gridTemplateColumns = `80px repeat(${Object.keys(dayMap).filter(d => d <= 5).length}, 1fr)`;

            // Render Day Headers (1-5 for Mon-Fri)
            container.innerHTML += `<div class="grid-header">Time</div>`;
            for (const day in dayMap) {
                if (day <= 5) {
                    container.innerHTML += `<div class="grid-header">${dayMap[day]}</div>`;
                }
            }

            // Render Periods/Rows
            periods.forEach(period => {
                // Time Cell (Row Header)
                const timeText = `${period.startTime} - ${period.endTime}`;
                container.innerHTML += `<div class="grid-header time-cell">${period.name}<br><small>(${timeText})</small></div>`;

                for (let day = 1; day <= 5; day++) {
                    const entry = schedule.find(s => s.day_of_week == day && s.period_number == period.id);
                    
                    let cellClass = 'lesson-cell';
                    let content = '+ Add Class';

                    if (period.type !== 'academic') {
                        cellClass = 'break-cell';
                        content = period.name;
                    } else if (entry) {
                        cellClass = 'lesson-cell bg-light'; // Lesson scheduled
                        content = `
                            <strong>${entry.subject_name}</strong>
                            <small>${entry.teacher_name}</small>
                            <small class="text-muted">Room: ${entry.room_number}</small>
                        `;
                    }

                    // Add unique data attributes for the modal to use
                    container.innerHTML += `
                        <div class="${cellClass} grid-cell" 
                             data-day="${day}" 
                             data-day-name="${dayMap[day]}" 
                             data-period="${period.id}" 
                             data-class-id="${classId}"
                             data-bs-toggle="${period.type === 'academic' ? 'modal' : ''}" 
                             data-bs-target="${period.type === 'academic' ? '#scheduleModal' : ''}">
                            ${content}
                        </div>
                    `;
                }
            });
        }
        
        // Handle Modal Trigger
        const scheduleModalElement = document.getElementById('scheduleModal');
        const scheduleModal = new bootstrap.Modal(scheduleModalElement);

        scheduleModalElement.addEventListener('show.bs.modal', (e) => {
            const invoker = e.relatedTarget;
            if (!invoker || invoker.classList.contains('break-cell')) return;

            const day = invoker.getAttribute('data-day');
            const period = invoker.getAttribute('data-period');
            const classId = invoker.getAttribute('data-class-id');

            document.getElementById('modalDay').textContent = dayMap[day];
            document.getElementById('modalPeriod').textContent = period;
            
            document.getElementById('entryDayOfWeek').value = day;
            document.getElementById('entryPeriodNumber').value = period;
            document.getElementById('entryClassId').value = classId;
            document.getElementById('conflictAlert').classList.add('d-none');
        });

        // Handle Schedule Entry Submission (POST /schedule)
        document.getElementById('scheduleEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true;

            const classId = document.getElementById('classSelector').value;

            const payload = {
                dayOfWeek: parseInt(document.getElementById('entryDayOfWeek').value),
                classId: classId,
                periodNumber: parseInt(document.getElementById('entryPeriodNumber').value),
                subjectId: document.getElementById('entrySubjectId').value,
                teacherProfileId: document.getElementById('entryTeacherProfileId').value,
                roomNumber: document.getElementById('entryRoomNumber').value,
                academicYear: document.getElementById('academicYear').value
            };

            try {
                await apiFetch('/schedule', 'POST', payload);
                showNotification('Schedule entry saved successfully.', 'success');
                scheduleModal.hide();
                fetchSchedule(classId); // Refresh grid
            } catch (error) {
                document.getElementById('conflictAlert').textContent = error.message.includes('Scheduling conflict') ? error.message : 'Failed to save entry.';
                document.getElementById('conflictAlert').classList.remove('d-none');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('exportScheduleBtn').addEventListener('click', async () => {
            const classId = document.getElementById('classSelector').value;
            if (!classId) return showNotification('Select a class to export.', 'warning');
            
            try {
                const data = await apiFetch(`/export/${classId}?format=PDF`);
                showNotification(data.message, 'success');
            } catch {
                // Error handled by apiFetch
            }
        });

        // --- 2. Teacher Preferences Logic ---

        document.getElementById('addUnavailablePeriodBtn').addEventListener('click', () => {
            const container = document.getElementById('unavailablePeriodsContainer');
            const currentCount = container.querySelectorAll('.row').length;
            if (currentCount >= 5) {
                return showNotification('Maximum 5 unavailable periods allowed.', 'warning');
            }

            const newRow = document.createElement('div');
            newRow.className = 'row g-2 mb-2';
            newRow.innerHTML = `
                <div class="col-md-4">
                    <select class="form-select form-select-sm unavailable-day" required>
                        <option value="">Select Day</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control form-control-sm unavailable-period" placeholder="Period #" required min="1">
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm unavailable-reason" placeholder="Reason (Optional)">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-period-btn"><i class="bi bi-trash"></i></button>
                </div>
            `;
            container.appendChild(newRow);
        });

        document.getElementById('unavailablePeriodsContainer').addEventListener('click', (e) => {
            if (e.target.closest('.remove-period-btn')) {
                e.target.closest('.row').remove();
            }
        });

        document.getElementById('teacherPreferenceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true;

            const teacherId = document.getElementById('prefTeacherId').value;
            const periods = [];
            const rows = document.getElementById('unavailablePeriodsContainer').querySelectorAll('.row');

            rows.forEach(row => {
                const daySelect = row.querySelector('.unavailable-day');
                const periodInput = row.querySelector('.unavailable-period');
                const reasonInput = row.querySelector('.unavailable-reason');

                if (daySelect && periodInput && daySelect.value && periodInput.value) {
                    periods.push({
                        dayOfWeek: parseInt(daySelect.value),
                        periodNumber: parseInt(periodInput.value),
                        reason: reasonInput.value
                    });
                }
            });

            if (periods.length === 0) {
                showNotification('Add at least one unavailable period.', 'warning');
                btn.disabled = false;
                return;
            }

            const payload = {
                teacherId: teacherId,
                unavailablePeriods: periods
            };

            try {
                const data = await apiFetch('/teacher-preferences', 'POST', payload);
                showNotification(data.message, 'success');
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });

        // --- 4. Audit & Rollback Logic ---

        async function fetchAuditHistory() {
            const tableBody = document.getElementById('auditHistoryTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';
            
            try {
                const data = await apiFetch('/audit/history');
                const history = data.history;

                tableBody.innerHTML = '';
                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No audit history found.</td></tr>';
                    return;
                }

                history.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.version_name}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>${item.created_by}</td>
                        <td>${item.holiday_count || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger rollback-btn" data-version="${item.version_name}">Rollback</button>
                        </td>
                    `;
                });
            } catch {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load audit history.</td></tr>';
            }
        }

        document.getElementById('auditHistoryTableBody').addEventListener('click', async (e) => {
            if (e.target.classList.contains('rollback-btn')) {
                const versionName = e.target.getAttribute('data-version');
                const confirmed = confirm(`WARNING: Are you sure you want to rollback to version ${versionName}? This will overwrite the current schedule.`);
                
                if (!confirmed) return;

                e.target.disabled = true;
                e.target.textContent = 'Rolling back...';

                try {
                    const data = await apiFetch(`/audit/rollback/${versionName}`, 'POST', {});
                    showNotification(data.message, 'success');
                    fetchConfig();
                    fetchAuditHistory();
                    document.getElementById('refreshScheduleBtn').click(); // Refresh the grid
                } catch {
                    e.target.disabled = false;
                    e.target.textContent = 'Rollback';
                }
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig().then(() => {
                // Load default schedule after config is loaded
                document.getElementById('refreshScheduleBtn').click();
            });
            fetchAuditHistory();
        });
    </script>
</body>
</html>
