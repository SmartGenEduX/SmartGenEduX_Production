<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§  AI Question Extractor & Question Bank Builder</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #e8f5e9; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1200px; margin-top: 20px; }
        .card-header { background-color: #388e3c; /* Dark Green */ color: white; font-weight: bold; border-radius: 0.75rem 0.75rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 0.75rem; }
        .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem; }
        .nav-tabs .nav-link.active { background-color: #4caf50; color: white; border-color: #4caf50; }
        .question-item { border-left: 5px solid #ccc; padding-left: 10px; margin-bottom: 10px; }
        .question-item.verified { border-left-color: #28a745; }
        .question-item.needs-review { border-left-color: #ffc107; }
        .status-badge { font-size: 0.75rem; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-success"><i class="bi bi-robot"></i> AI Question Extractor Dashboard</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="extractorTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-section" type="button"><i class="bi bi-file-earmark-arrow-up"></i> Upload & Process</button></li>
            <li class="nav-item"><button class="nav-link" id="verify-tab" data-bs-toggle="tab" data-bs-target="#verification-section" type="button"><i class="bi bi-check2-square"></i> Verification Workflow</button></li>
            <li class="nav-item"><button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-section" type="button"><i class="bi bi-graph-up"></i> Analytics</button></li>
            <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-section" type="button"><i class="bi bi-sliders"></i> AI Configuration</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="extractorTabContent">

            <!-- 1. Upload & Process Tab (POST /upload, GET /documents) -->
            <div class="tab-pane fade show active" id="upload-section" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Upload Document for Extraction</div>
                    <div class="card-body">
                        
                        <form id="uploadForm" enctype="multipart/form-data" class="row g-3">
                            <div class="col-md-6">
                                <label for="documentFile" class="form-label">Upload Question Paper (PDF/DOCX)</label>
                                <input type="file" class="form-control" id="documentFile" name="documentFile" accept=".pdf,.doc,.docx" required>
                                <div class="form-text">Max file size: <span id="maxFileSizeText">5 MB</span>. Only PDF, DOCX allowed.</div>
                            </div>
                            <div class="col-md-3">
                                <label for="subjectId" class="form-label">Subject ID</label>
                                <select class="form-select" id="subjectId" name="subjectId" required>
                                    <option value="">Select Subject</option>
                                    <option value="MATH">Mathematics</option>
                                    <option value="PHY">Physics</option>
                                    <option value="CHE">Chemistry</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="classId" class="form-label">Class ID</label>
                                <select class="form-select" id="classId" name="classId" required>
                                    <option value="">Select Class</option>
                                    <option value="X">Class X</option>
                                    <option value="XII">Class XII</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="extractionMethod" class="form-label">Extraction Method Preference</label>
                                <select class="form-select" id="extractionMethod" name="extractionMethod">
                                    <option value="enhanced_ocr">Enhanced OCR (Default)</option>
                                    <option value="basic_ocr">Basic OCR (Fast)</option>
                                    <option value="ai_enhanced">AI Enhanced (Slow, High Accuracy)</option>
                                </select>
                            </div>
                            <input type="hidden" name="uploadedBy" value="11111111-1111-1111-1111-111111111111">
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-success btn-lg" id="uploadBtn"><i class="bi bi-cloud-arrow-up"></i> Upload & Queue for AI Extraction</button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <h5>Extraction History</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Doc ID</th>
                                        <th>File Name</th>
                                        <th>Uploaded</th>
                                        <th>Status</th>
                                        <th>Questions</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="documentHistoryTable">
                                    <tr><td colspan="6" class="text-center">Loading history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Verification Workflow Tab (GET /documents/:id/questions, POST /questions/:id/verify, POST /questions/bulk-verify) -->
            <div class="tab-pane fade" id="verification-section" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-warning text-dark">Human-in-the-Loop Verification</div>
                    <div class="card-body">
                        
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="targetDocumentId" placeholder="Enter Document ID to review questions">
                            <button class="btn btn-primary" type="button" id="loadQuestionsBtn"><i class="bi bi-arrow-right-square"></i> Load Questions</button>
                        </div>
                        
                        <div id="bulkControls" class="d-none alert alert-light p-3">
                            <p class="fw-bold">Bulk Action on <span id="bulkCount">0</span> selected questions:</p>
                            <textarea class="form-control mb-2" id="bulkRemarks" placeholder="Optional remarks for bulk action..."></textarea>
                            <button class="btn btn-sm btn-success bulk-verify-btn" data-verified="true"><i class="bi bi-check-all"></i> Bulk Verify Selected</button>
                            <button class="btn btn-sm btn-danger bulk-verify-btn" data-verified="false"><i class="bi bi-x-octagon"></i> Bulk Reject/Review</button>
                        </div>

                        <div id="questionsList" class="mt-4">
                            <p class="text-muted text-center">Load a document ID above to see extracted questions awaiting verification.</p>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 3. Analytics Tab (GET /statistics) -->
            <div class="tab-pane fade" id="analytics-section" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-info">Extraction Analytics & Status</div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-4 border rounded bg-light">
                                    <h2 class="text-primary" id="totalExtracted">...</h2>
                                    <p class="text-muted">Total Questions Extracted</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-4 border rounded bg-light">
                                    <h2 class="text-success" id="verifiedCount">...</h2>
                                    <p class="text-muted">Verified & Ready for QPG</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-4 border rounded bg-light">
                                    <h2 class="text-warning" id="processingCount">...</h2>
                                    <p class="text-muted">Currently Processing</p>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-info mt-3" id="refreshStatsBtn"><i class="bi bi-arrow-clockwise"></i> Refresh Statistics</button>
                    </div>
                </div>
            </div>

            <!-- 4. Configuration Tab (GET/PUT /config) -->
            <div class="tab-pane fade" id="config-section" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-danger">AI Model & Extraction Configuration (Manager Only)</div>
                    <div class="card-body">
                        <p class="alert alert-danger small"><i class="bi bi-lock-fill"></i> Only School Admin/Principal can manage these critical AI and compliance settings.</p>
                        
                        <form id="configForm" class="row g-3">
                            <h5 class="text-danger">A. AI Model & Quality Control</h5>
                            <div class="col-md-6">
                                <label for="aiModel" class="form-label">Preferred AI Extraction Model</label>
                                <select class="form-select" id="aiModel" name="aiModelPreference" required>
                                    <option value="enhanced_ocr">Enhanced OCR (Best Balance)</option>
                                    <option value="basic_ocr">Basic OCR (Cost Effective)</option>
                                    <option value="ai_enhanced">AI Enhanced (Highest Accuracy/Cost)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="confidenceThreshold" class="form-label">AI Confidence Threshold (%)</label>
                                <input type="number" class="form-control" id="confidenceThreshold" name="confidenceThreshold" min="50" max="100" required>
                                <div class="form-text">Questions below this score are automatically flagged for human review.</div>
                            </div>

                            <hr class="my-3">
                            
                            <h5 class="text-danger">B. Compliance & Auto-Pilot</h5>
                            <div class="col-md-4">
                                <label for="maxFileSize" class="form-label">Max File Size (MB)</label>
                                <input type="number" class="form-control" id="maxFileSize" name="maxFileSizeMb" min="1" max="50" required>
                            </div>
                            <div class="col-md-4">
                                <label for="supportedLanguages" class="form-label">Supported Languages (Comma Separated)</label>
                                <input type="text" class="form-control" id="supportedLanguages" name="supportedLanguages" placeholder="English, Hindi, Tamil" required>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="autoVerificationEnabled" name="autoVerificationEnabled">
                                    <label class="form-check-label" for="autoVerificationEnabled">Enable Auto-Verification</label>
                                    <div class="form-text">Automatically verifies questions above the confidence threshold.</div>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-danger btn-lg w-100" id="saveConfigBtn"><i class="bi bi-save"></i> Save AI & Extraction Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Modal for Single Question Verification -->
    <div class="modal fade" id="verifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Verify Question <span id="modalQuestionId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="singleVerifyForm">
                    <div class="modal-body">
                        <input type="hidden" id="currentQuestionId">
                        <div class="mb-3">
                            <label class="form-label">Extracted Content:</label>
                            <textarea class="form-control" id="modalQuestionContent" rows="5" readonly></textarea>
                            <div class="form-text mt-2">Page: <span id="modalPageNumber"></span> | Status: <span id="modalCurrentStatus" class="badge"></span></div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalMarks" class="form-label">Marks</label>
                                <input type="number" class="form-control" id="modalMarks" min="1" max="10" required>
                            </div>
                            <div class="col-md-6">
                                <label for="modalDifficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="modalDifficulty" required>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modalRemarks" class="form-label">Verification Remarks</label>
                            <textarea class="form-control" id="modalRemarks" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success" data-verification="true" id="saveVerificationBtn"><i class="bi bi-check-circle"></i> Mark Verified</button>
                        <button type="button" class="btn btn-warning" data-verification="false" id="flagForReviewBtn"><i class="bi bi-flag"></i> Flag for Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        const MOCK_JWT_TOKEN = 'mock.jwt.token.for.auth'; 
        let currentQuestions = []; // Stores questions for verification tab
        let currentDocumentId = null;

        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => { area.style.display = 'none'; }, 7000);
        }

        /** Core Fetch Function with JWT Auth Header. */
        async function apiFetch(endpoint, method = 'GET', body = null, isFormData = false) {
            try {
                const options = {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${MOCK_JWT_TOKEN}` 
                    },
                };
                
                if (body && method !== 'GET') {
                    if (!isFormData) {
                        options.headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    } else {
                        options.body = body;
                    }
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error. Check console for details.', 'danger');
                throw error;
            }
        }
        
        // --- 1. UPLOAD LOGIC ---

        async function fetchDocumentHistory() {
            const tableBody = document.getElementById('documentHistoryTable');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

            try {
                const data = await apiFetch('/documents');
                tableBody.innerHTML = '';
                
                if (data.documents.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No documents have been uploaded yet.</td></tr>';
                    return;
                }

                data.documents.forEach(doc => {
                    const statusClass = {
                        'queued': 'bg-secondary',
                        'processing': 'bg-primary',
                        'completed': 'bg-success',
                        'failed': 'bg-danger'
                    }[doc.processing_status] || 'bg-dark';

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="small">${doc.id.substring(0, 8)}...</td>
                        <td>${doc.file_name}</td>
                        <td>${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                        <td><span class="badge ${statusClass}">${doc.processing_status.toUpperCase()}</span></td>
                        <td>${doc.questions_extracted || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning review-doc-btn" data-doc-id="${doc.id}" ${doc.processing_status !== 'completed' ? 'disabled' : ''}>Review</button>
                        </td>
                    `;
                });

            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load history.</td></tr>';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('uploadBtn');
            
            const fileInput = document.getElementById('documentFile');
            if (!fileInput.files[0]) return;

            const formData = new FormData();
            formData.append('documentFile', fileInput.files[0]);
            formData.append('subjectId', form.subjectId.value);
            formData.append('classId', form.classId.value);
            formData.append('uploadedBy', form.uploadedBy.value); 
            formData.append('extractionMethod', form.extractionMethod.value);

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing & Uploading...';

            try {
                const data = await apiFetch('/upload', 'POST', formData, true);
                showNotification(data.message + ` Document ID: ${data.documentId}`, 'success');
                form.reset();
                fetchDocumentHistory(); // Refresh history table
                fetchStatistics(); // Update analytics
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Upload & Queue for AI Extraction';
            }
        });

        // Delegate click for Review button to automatically load verification tab
        document.getElementById('documentHistoryTable').addEventListener('click', (e) => {
            if (e.target.classList.contains('review-doc-btn')) {
                const docId = e.target.getAttribute('data-doc-id');
                document.getElementById('targetDocumentId').value = docId;
                document.getElementById('loadQuestionsBtn').click();
                
                // Switch tab to Verification
                const verifyTab = new bootstrap.Tab(document.getElementById('verify-tab'));
                verifyTab.show();
            }
        });


        // --- 2. VERIFICATION WORKFLOW LOGIC ---

        async function loadQuestions() {
            const docId = document.getElementById('targetDocumentId').value.trim();
            if (!docId) {
                showNotification('Please enter a valid Document ID.', 'warning');
                return;
            }
            
            const listContainer = document.getElementById('questionsList');
            const btn = document.getElementById('loadQuestionsBtn');
            
            listContainer.innerHTML = '<p class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading questions...</p>';
            btn.disabled = true;
            currentDocumentId = docId;
            
            try {
                const data = await apiFetch(`/documents/${docId}/questions`);
                currentQuestions = data.questions;
                renderQuestionsList(data.questions);
            } catch (error) {
                listContainer.innerHTML = `<p class="text-danger text-center">Failed to load questions for Document ID: ${docId}. Check ID or status.</p>`;
                document.getElementById('bulkControls').classList.add('d-none');
            } finally {
                btn.disabled = false;
            }
        }

        function renderQuestionsList(questions) {
            const listContainer = document.getElementById('questionsList');
            if (questions.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-warning">No questions extracted for this document yet.</p>';
                document.getElementById('bulkControls').classList.add('d-none');
                return;
            }

            let html = '<ul class="list-unstyled">';
            questions.forEach(q => {
                const status = q.verified_status || 'unverified';
                const statusClass = status === 'verified' ? 'bg-success' : (status === 'needs_review' ? 'bg-danger' : 'bg-secondary');
                const itemClass = status === 'verified' ? 'verified' : (status === 'needs_review' ? 'needs-review' : '');
                
                html += `
                    <li class="question-item p-3 mb-3 border rounded ${itemClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input question-checkbox" type="checkbox" value="${q.id}" data-id="${q.id}">
                                <label class="form-check-label fw-bold">Q${q.page_number}.${q.question_number} </label>
                                <span class="badge ${statusClass} status-badge">${status.toUpperCase()}</span>
                                <span class="badge bg-info status-badge ms-2">Marks: ${q.marks || '?'}</span>
                                <span class="badge bg-dark status-badge">Diff: ${q.difficulty || '?' }</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary single-verify-btn" data-bs-toggle="modal" data-bs-target="#verifyModal" data-question-id="${q.id}">Edit / Verify</button>
                        </div>
                        <p class="mt-2 mb-0 small text-muted">${q.question_text.substring(0, 150)}...</p>
                    </li>
                `;
            });
            html += '</ul>';
            listContainer.innerHTML = html;

            document.getElementById('bulkControls').classList.remove('d-none');
        }

        document.getElementById('loadQuestionsBtn').addEventListener('click', loadQuestions);
        document.getElementById('targetDocumentId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                loadQuestions();
            }
        });

        // Delegation for Review/Edit button
        document.getElementById('questionsList').addEventListener('click', (e) => {
            if (e.target.classList.contains('single-verify-btn')) {
                const qId = e.target.getAttribute('data-question-id');
                const question = currentQuestions.find(q => q.id === qId);
                if (!question) return;

                document.getElementById('currentQuestionId').value = qId;
                document.getElementById('modalQuestionId').textContent = qId.substring(0, 8);
                document.getElementById('modalQuestionContent').value = question.question_text;
                document.getElementById('modalPageNumber').textContent = question.page_number;
                
                // Populate fields with existing data
                document.getElementById('modalMarks').value = question.marks || 5;
                document.getElementById('modalDifficulty').value = question.difficulty || 'medium';
                document.getElementById('modalRemarks').value = question.verification_notes || '';
                
                const status = question.verified_status || 'unverified';
                const statusClass = status === 'verified' ? 'bg-success' : 'bg-warning text-dark';
                document.getElementById('modalCurrentStatus').textContent = status.toUpperCase();
                document.getElementById('modalCurrentStatus').className = `badge ${statusClass}`;
            }
        });

        // Handle Single Verification Form Submission
        document.getElementById('singleVerifyForm').addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || !(target.id === 'saveVerificationBtn' || target.id === 'flagForReviewBtn')) return;
            e.preventDefault();

            const qId = document.getElementById('currentQuestionId').value;
            const isVerified = target.getAttribute('data-verification') === 'true';
            
            const payload = {
                isVerified: isVerified,
                marks: parseInt(document.getElementById('modalMarks').value),
                difficulty: document.getElementById('modalDifficulty').value,
                remarks: document.getElementById('modalRemarks').value
            };

            const btnText = target.textContent;
            target.disabled = true;
            target.textContent = 'Saving...';
            
            try {
                const data = await apiFetch(`/questions/${qId}/verify`, 'POST', payload);
                showNotification(data.message, 'success');
                
                // Reload questions and close modal
                loadQuestions();
                bootstrap.Modal.getInstance(document.getElementById('verifyModal')).hide();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                target.disabled = false;
                target.textContent = btnText;
            }
        });
        
        // Handle Bulk Verification Selection
        document.getElementById('questionsList').addEventListener('change', () => {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            document.getElementById('bulkCount').textContent = selected.length;
        });

        // Handle Bulk Verification Action
        document.getElementById('bulkControls').addEventListener('click', async (e) => {
            const target = e.target.closest('button.bulk-verify-btn');
            if (!target) return;
            
            const isVerified = target.getAttribute('data-verified') === 'true';
            const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
            const questionIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (questionIds.length === 0) {
                showNotification('Select at least one question for bulk action.', 'warning');
                return;
            }

            const payload = {
                questionIds: questionIds,
                isVerified: isVerified,
                remarks: document.getElementById('bulkRemarks').value
            };
            
            const btnText = target.textContent;
            target.disabled = true;
            target.textContent = 'Processing...';

            try {
                const data = await apiFetch('/questions/bulk-verify', 'POST', payload);
                showNotification(data.message, 'success');
                loadQuestions();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                target.disabled = false;
                target.textContent = btnText;
            }
        });
        

        // --- 3. ANALYTICS LOGIC ---
        
        async function fetchStatistics() {
            try {
                const data = await apiFetch('/statistics');
                const summary = data.summary;
                
                document.getElementById('totalExtracted').textContent = summary.total_extracted || 0;
                document.getElementById('verifiedCount').textContent = summary.verified_count || 0;
                document.getElementById('processingCount').textContent = summary.processing_count || 0;
            } catch (error) {
                // Display error message on the dashboard if needed
            }
        }
        
        document.getElementById('refreshStatsBtn').addEventListener('click', fetchStatistics);


        // --- 4. CONFIGURATION LOGIC ---
        
        async function fetchConfig() {
            try {
                const data = await apiFetch('/config');
                const settings = data.settings;
                
                document.getElementById('aiModel').value = settings.ai_model_preference || 'enhanced_ocr';
                document.getElementById('confidenceThreshold').value = settings.confidence_threshold || 90;
                document.getElementById('autoVerificationEnabled').checked = settings.auto_verification_enabled || false;
                document.getElementById('maxFileSize').value = settings.max_file_size_mb || 5;
                document.getElementById('supportedLanguages').value = (settings.supported_languages || ['English']).join(', ');
                
                // Update file size text in the upload tab
                document.getElementById('maxFileSizeText').textContent = `${settings.max_file_size_mb || 5} MB`;

            } catch (error) {
                showNotification('Configuration loaded with default fallback values (or access denied).', 'warning');
            }
        }
        
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveConfigBtn');
            
            const payload = {
                ai_model_preference: form.aiModel.value,
                confidence_threshold: parseInt(form.confidenceThreshold.value),
                auto_verification_enabled: form.autoVerificationEnabled.checked,
                max_file_size_mb: parseInt(form.maxFileSize.value),
                supported_languages: form.supportedLanguages.value.split(',').map(s => s.trim())
            };

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message, 'success');
                fetchConfig(); // Refresh settings display
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> Save AI & Extraction Configuration';
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig();
            fetchDocumentHistory();
            fetchStatistics();
        });

    </script>
</body>
</html>
