<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóìÔ∏è School Event Log & Compliance</title>
    <!-- Bootstrap 5 CDN for styling and responsiveness -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1200px; margin-top: 20px; }
        .card-header { background-color: #00796b; /* Teal */ color: white; font-weight: bold; border-radius: 0.5rem 0.5rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem; }
        .nav-tabs .nav-link.active { background-color: #00897b; color: white; border-color: #00897b; }
        .event-badge {
            font-size: 0.75rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-primary"><i class="bi bi-calendar-event"></i> School Event Log & Compliance Dashboard</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="eventTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#event-creation" type="button"><i class="bi bi-plus-square"></i> Calendar & Creation</button></li>
            <li class="nav-item"><button class="nav-link" id="workflow-tab" data-bs-toggle="tab" data-bs-target="#event-workflow" type="button"><i class="bi bi-patch-check"></i> Approval & Notifications</button></li>
            <li class="nav-item"><button class="nav-link" id="feed-tab" data-bs-toggle="tab" data-bs-target="#event-feed" type="button"><i class="bi bi-broadcast-pin"></i> Live Event Feed</button></li>
            <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#event-config" type="button"><i class="bi bi-gear-fill"></i> Configuration</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="eventTabContent">

            <!-- 1. Calendar & Creation Tab (POST /, GET /) -->
            <div class="tab-pane fade show active" id="event-creation" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-success">Event Planning & Venue Conflict Check</div>
                    <div class="card-body">
                        
                        <h5 class="text-success">A. Create New Event</h5>
                        <form id="eventForm" class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="eventTitle" class="form-label">Event Title</label>
                                <input type="text" class="form-control" id="eventTitle" required maxlength="255">
                            </div>
                            <div class="col-md-6">
                                <label for="eventType" class="form-label">Type</label>
                                <select class="form-select" id="eventType" required>
                                    <option value="academic">Academic</option>
                                    <option value="sports">Sports</option>
                                    <option value="cultural">Cultural</option>
                                    <option value="meeting">Meeting</option>
                                    <option value="competition">Competition</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="celebration">Celebration</option>
                                    <option value="trip">Trip/Excursion</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                            <div class="col-md-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                            <div class="col-md-4">
                                <label for="venue" class="form-label">Venue</label>
                                <input type="text" class="form-control" id="venue" placeholder="e.g., Auditorium, Ground A" required>
                            </div>
                            <div class="col-md-4">
                                <label for="organizer" class="form-label">Organizer/Incharge</label>
                                <input type="text" class="form-control" id="organizer" required>
                            </div>
                            <div class="col-md-4">
                                <label for="allocatedBudget" class="form-label">Allocated Budget (Optional)</label>
                                <input type="number" class="form-control" id="allocatedBudget" min="0" placeholder="‚Çπ">
                            </div>
                             <div class="col-md-6">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" required>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High (Requires Principal Alert)</option>
                                    <option value="urgent">Urgent (Requires Immediate Principal Alert)</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="description" class="form-label">Description (Max 1000 chars)</label>
                                <textarea class="form-control" id="description" rows="2" maxlength="1000"></textarea>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success" id="createEventBtn"><i class="bi bi-check-circle"></i> Create Event (Planning)</button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <h5 class="text-primary">B. Upcoming Events (Live Calendar View)</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Venue</th>
                                        <th>Dates</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="eventListBody">
                                    <tr><td colspan="5" class="text-center">Loading events...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Approval & Notifications Tab (POST /:eventId/approve, POST /:eventId/notify) -->
            <div class="tab-pane fade" id="event-workflow" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-warning text-dark">Principal Approval & Communication</div>
                    <div class="card-body">
                        
                        <!-- Approval Section -->
                        <h5 class="text-warning">A. Event Approval (Principal/Approver Only)</h5>
                        <form id="approvalForm" class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label for="approveEventId" class="form-label">Event ID to Approve</label>
                                <input type="text" class="form-control" id="approveEventId" placeholder="e.g., EVT-123" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-warning mt-4 w-100" id="approveBtn"><i class="bi bi-patch-check-fill"></i> Approve Event</button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <!-- Notification Section -->
                        <h5 class="text-info">B. Send Final Reminder / Notification</h5>
                        <form id="notifyForm" class="row g-3">
                            <div class="col-md-4">
                                <label for="notifyEventId" class="form-label">Event ID</label>
                                <input type="text" class="form-control" id="notifyEventId" placeholder="e.g., EVT-123" required>
                            </div>
                            <div class="col-md-4">
                                <label for="notifyRecipients" class="form-label">Recipients (Comma Separated)</label>
                                <select class="form-select" id="notifyRecipients" multiple required>
                                    <option value="parents" selected>Parents</option>
                                    <option value="students">Students</option>
                                    <option value="staff">Staff</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="notifyMethod" class="form-label">Delivery Method</label>
                                <select class="form-select" id="notifyMethod" required>
                                    <option value="whatsapp" selected>WhatsApp (Arattai)</option>
                                    <option value="email">Email</option>
                                    <option value="sms">SMS</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="notifyMessage" class="form-label">Custom Message (Template Message)</label>
                                <textarea class="form-control" id="notifyMessage" rows="3" required placeholder="Event starts soon! Don't forget your materials."></textarea>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-info" id="notifyBtn"><i class="bi bi-send-fill"></i> Send Notification</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 3. Live Event Feed Tab (Gated by Config) -->
            <div class="tab-pane fade" id="event-feed" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-primary">Live Event Feed (Filtered by Configuration)</div>
                    <div class="card-body">
                        <p class="alert alert-info small">This feed dynamically monitors and displays events matching the **Configured Priority** and **Types** (set in the Configuration tab).</p>
                        <div id="liveFeedBody">
                            <p class="text-muted text-center">No live events matching the configured filters...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. Configuration Tab (GET/PUT /config) -->
            <div class="tab-pane fade" id="event-config" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-dark">Live Monitoring Configuration (Admin/Principal Only)</div>
                    <div class="card-body">
                        <form id="configForm" class="row g-3">
                            <p class="alert alert-warning small">These settings control which events appear on the **Live Event Feed** tab for real-time monitoring.</p>
                            
                            <div class="col-md-6">
                                <label for="liveFeedTypes" class="form-label">Live Feed Event Types (Select Multiple)</label>
                                <select class="form-select" id="liveFeedTypes" multiple required>
                                    <option value="academic">Academic</option>
                                    <option value="sports">Sports</option>
                                    <option value="cultural">Cultural</option>
                                    <option value="meeting">Meeting</option>
                                    <option value="competition">Competition</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="celebration">Celebration</option>
                                    <option value="trip">Trip/Excursion</option>
                                </select>
                                <div class="form-text">Events of these types will appear in the Live Feed.</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="liveFeedPriority" class="form-label">Minimum Live Feed Priority</label>
                                <select class="form-select" id="liveFeedPriority" required>
                                    <option value="urgent">Urgent</option>
                                    <option value="high" selected>High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                                <div class="form-text">Only events at this priority level or higher will be monitored.</div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-dark btn-lg w-100" id="saveConfigBtn"><i class="bi bi-save"></i> Save Live Feed Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        const MOCK_JWT_TOKEN = 'mock.jwt.token.for.auth'; 
        
        let mockEvents = [
            { id: 'EVT-123', title: 'Annual Sports Day', type: 'sports', startDate: '2025-10-20', endDate: '2025-10-20', startTime: '09:00', endTime: '16:00', venue: 'Main Ground', status: 'approved', priority: 'high', organizer: 'Mr. Sharma' },
            { id: 'EVT-124', title: 'PTA Meeting', type: 'meeting', startDate: '2025-11-05', endDate: '2025-11-05', startTime: '17:00', endTime: '18:00', venue: 'Auditorium', status: 'planning', priority: 'medium', organizer: 'Principal' },
            { id: 'EVT-125', title: 'Science Fair', type: 'academic', startDate: '2025-12-01', endDate: '2025-12-02', startTime: '10:00', endTime: '15:00', venue: 'Science Block', status: 'approved', priority: 'medium', organizer: 'Ms. Kapoor' },
        ];
        
        let currentConfig = { liveFeedTypes: ['sports', 'meeting'], liveFeedPriority: 'high' };

        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => { area.style.display = 'none'; }, 7000);
        }

        /** Core Fetch Function with JWT Auth Header. */
        async function apiFetch(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MOCK_JWT_TOKEN}` 
                    },
                };
                
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error. Check console for details.', 'danger');
                throw error;
            }
        }
        
        const getStatusBadge = (status) => {
            switch(status) {
                case 'approved': return 'bg-success';
                case 'planning': return 'bg-warning text-dark';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        };

        const getPriorityBadge = (priority) => {
            switch(priority) {
                case 'urgent': return 'bg-danger';
                case 'high': return 'bg-warning text-dark';
                case 'medium': return 'bg-info';
                default: return 'bg-light text-dark';
            }
        };


        // --- 1. EVENT CREATION & CALENDAR LOGIC ---

        async function fetchEventList() {
            const tableBody = document.getElementById('eventListBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading events...</td></tr>';
            
            try {
                // In production, pass search/filter query params here
                const data = await apiFetch('/'); 
                
                tableBody.innerHTML = '';
                if (data.events.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No upcoming events scheduled.</td></tr>';
                    return;
                }

                data.events.forEach(event => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${event.title} <span class="badge ${getPriorityBadge(event.priority)} event-badge">${event.priority.toUpperCase()}</span></td>
                        <td>${event.venue}</td>
                        <td>${new Date(event.start_date).toLocaleDateString()} - ${new Date(event.end_date).toLocaleDateString()}</td>
                        <td>${event.start_time} - ${event.end_time}</td>
                        <td><span class="badge ${getStatusBadge(event.status)}">${event.status.toUpperCase()}</span></td>
                    `;
                });
                
                mockEvents = data.events; // Update mock data for live feed simulation
                updateLiveFeed();

            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load events.</td></tr>';
            }
        }

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('createEventBtn');
            
            const payload = {
                title: form.eventTitle.value,
                type: form.eventType.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                startTime: form.startTime.value,
                endTime: form.endTime.value,
                venue: form.venue.value,
                organizer: form.organizer.value,
                allocatedBudget: form.allocatedBudget.value ? parseFloat(form.allocatedBudget.value) : 0,
                description: form.description.value,
                priority: form.priority.value,
                targetAudience: ['students', 'parents'] // Mock target audience
            };

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

            try {
                const data = await apiFetch('/', 'POST', payload);
                showNotification(data.message, 'success');
                form.reset();
                fetchEventList(); 
            } catch (error) {
                // Handled by apiFetch (Will catch 409 conflict error)
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Create Event (Planning)';
            }
        });
        
        // --- 2. WORKFLOW LOGIC ---
        
        document.getElementById('approvalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventId = document.getElementById('approveEventId').value;
            const btn = document.getElementById('approveBtn');
            
            btn.disabled = true;
            btn.textContent = 'Approving...';

            try {
                const data = await apiFetch(`/${eventId}/approve`, 'POST', {});
                showNotification(data.message, 'success');
                fetchEventList(); 
            } catch (error) {
                // Handled by apiFetch (Will catch 403 authorization error)
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-patch-check-fill"></i> Approve Event';
            }
        });
        
        document.getElementById('notifyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('notifyBtn');
            
            const recipientsArray = Array.from(form.notifyRecipients.selectedOptions).map(opt => opt.value);

            const payload = {
                message: form.notifyMessage.value,
                recipients: recipientsArray,
                method: form.notifyMethod.value
            };
            const eventId = form.notifyEventId.value;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            try {
                const data = await apiFetch(`/${eventId}/notify`, 'POST', payload);
                showNotification(data.message, 'success');
                form.reset();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send-fill"></i> Send Notification';
            }
        });

        // --- 3. LIVE EVENT FEED LOGIC ---
        
        const priorityOrder = { 'low': 1, 'medium': 2, 'high': 3, 'urgent': 4 };

        function updateLiveFeed() {
            const feedDiv = document.getElementById('liveFeedBody');
            const { liveFeedTypes, liveFeedPriority } = currentConfig;
            
            if (!liveFeedTypes || liveFeedTypes.length === 0) {
                feedDiv.innerHTML = '<p class="text-warning text-center">Live feed disabled: No event types are configured for monitoring.</p>';
                return;
            }

            const minPriorityValue = priorityOrder[liveFeedPriority] || 0;
            
            const liveEvents = mockEvents
                .filter(event => new Date(event.startDate) >= new Date(new Date().setHours(0, 0, 0, 0))) // Filter for today or future events
                .filter(event => liveFeedTypes.includes(event.type)) // Filter by configured type
                .filter(event => priorityOrder[event.priority] >= minPriorityValue) // Filter by configured minimum priority
                .sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]); // Sort by urgency

            if (liveEvents.length === 0) {
                feedDiv.innerHTML = '<p class="text-muted text-center">No events currently match the live monitoring filters.</p>';
                return;
            }

            let html = '<ul class="list-group">';
            liveEvents.forEach(event => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-${event.priority === 'urgent' ? 'danger' : (event.priority === 'high' ? 'warning' : 'light')}">
                        <div>
                            <strong>${event.title}</strong> (${event.organizer})
                            <span class="badge ${getPriorityBadge(event.priority)}">${event.priority.toUpperCase()}</span>
                            <span class="badge bg-secondary">${event.venue}</span>
                        </div>
                        <small class="text-muted">${new Date(event.startDate).toLocaleDateString()} @ ${event.startTime}</small>
                    </li>
                `;
            });
            html += '</ul>';
            feedDiv.innerHTML = html;
        }

        // --- 4. CONFIGURATION LOGIC ---

        async function fetchConfig() {
            try {
                const data = await apiFetch('/config');
                const settings = data.settings;
                
                // Set global configuration variable
                currentConfig = { 
                    liveFeedTypes: settings.live_feed_types || [], 
                    liveFeedPriority: settings.live_feed_priority || 'medium' 
                };

                // Populate form fields
                const selectTypes = document.getElementById('liveFeedTypes');
                Array.from(selectTypes.options).forEach(option => {
                    option.selected = currentConfig.liveFeedTypes.includes(option.value);
                });
                document.getElementById('liveFeedPriority').value = currentConfig.liveFeedPriority;

                // Update the live feed immediately after fetching config
                updateLiveFeed(); 

            } catch (error) {
                showNotification('Could not fetch configuration. Using default Live Feed settings.', 'warning');
            }
        }

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveConfigBtn');
            
            const liveFeedTypes = Array.from(form.liveFeedTypes.selectedOptions).map(opt => opt.value);

            const payload = {
                liveFeedTypes: liveFeedTypes,
                liveFeedPriority: form.liveFeedPriority.value
            };

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message, 'success');
                // Update local config and refresh feed
                currentConfig = data.newSettings;
                updateLiveFeed();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> Save Live Feed Configuration';
            }
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig();
            fetchEventList();
        });

    </script>
</body>
</html>
