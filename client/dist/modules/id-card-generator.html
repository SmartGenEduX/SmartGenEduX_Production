<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🆔 ID Card Generator & Management</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f4f8; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1200px; margin-top: 20px; }
        .card-header { background-color: #3f51b5; /* Indigo */ color: white; font-weight: bold; border-radius: 0.75rem 0.75rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-radius: 0.75rem; }
        .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem; }
        .nav-tabs .nav-link.active { background-color: #3f51b5; color: white; border-color: #3f51b5; }
        
        /* ID Card Preview Styles */
        .id-card {
            width: 300px; height: 450px; background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 12px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; font-size: 14px;
        }
        .id-card-header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #3f51b5; padding-bottom: 5px; }
        .id-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #3f51b5; margin: 0 auto 10px; display: block; }
        .id-detail { margin-bottom: 5px; }
        .id-barcode { text-align: center; margin-top: 15px; border-top: 1px dashed #999; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-primary"><i class="bi bi-person-badge"></i> ID Card Generation & Approval Portal</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="idCardTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="request-tab" data-bs-toggle="tab" data-bs-target="#request-submission" type="button"><i class="bi bi-file-earmark-plus"></i> New Request</button></li>
            <li class="nav-item"><button class="nav-link" id="workflow-tab" data-bs-toggle="tab" data-bs-target="#workflow-review" type="button"><i class="bi bi-list-check"></i> Approval Workflow</button></li>
            <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-setup" type="button"><i class="bi bi-gear-fill"></i> Configuration Hub</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="idCardTabContent">

            <!-- 1. Request Submission Tab (POST /requests, POST /applications/:id/upload-document) -->
            <div class="tab-pane fade show active" id="request-submission" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-success">Step 1: Data Submission & Photo Upload</div>
                    <div class="card-body">
                        <p class="alert alert-info small"><i class="bi bi-info-circle"></i> Submitting this form automatically **generates and links a unique Barcode UID** for the Attendance System, ensuring compliance for the new ID.</p>
                        
                        <form id="requestForm" class="row g-3">
                            <div class="col-md-4">
                                <label for="userType" class="form-label">User Type</label>
                                <select class="form-select" id="userType" required>
                                    <option value="student">Student</option>
                                    <option value="staff">Staff / Teacher</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label for="targetEntityId" class="form-label">Target Profile ID (Student/Staff Internal ID)</label>
                                <input type="text" class="form-control" id="targetEntityId" placeholder="e.g., UUID or Internal ID (required for barcode link)" required>
                            </div>

                            <div class="col-md-6">
                                <label for="fullName" class="form-label">Full Name on Card</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="cardTitle" class="form-label">Title/Designation (e.g., Class X-B, Physics Teacher)</label>
                                <input type="text" class="form-control" id="cardTitle" required>
                            </div>
                            
                            <h6 class="mt-4">Required Data for Card</h6>
                            <div class="col-md-4"><input type="text" class="form-control form-control-sm" placeholder="Contact Phone" id="contactPhone" required></div>
                            <div class="col-md-4"><input type="text" class="form-control form-control-sm" placeholder="Emergency Contact" id="emergencyContact"></div>
                            <div class="col-md-4"><input type="date" class="form-control form-control-sm" id="dob" required></div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-success" id="submitRequestBtn"><i class="bi bi-file-earmark-arrow-up"></i> Submit Data & Generate Barcode</button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <!-- Photo Upload (Separate Step) -->
                        <h5 class="text-primary">Step 2: Upload Profile Photo</h5>
                        <form id="photoUploadForm" class="row g-3" enctype="multipart/form-data">
                            <div class="col-md-6">
                                <label for="requestIdUpload" class="form-label">Request ID (from Step 1)</label>
                                <input type="text" class="form-control" id="requestIdUpload" placeholder="Paste Request ID here" required>
                            </div>
                            <div class="col-md-6">
                                <label for="profilePhoto" class="form-label">Photo (JPEG/PNG, Max 10MB)</label>
                                <input type="file" class="form-control" id="profilePhoto" name="document" accept=".jpg,.jpeg,.png" required>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary" id="uploadPhotoBtn"><i class="bi bi-image"></i> Upload Photo & Finalize Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 2. Approval Workflow Tab (GET /requests, POST /requests/:id/generate, POST /requests/:id/approve, GET /requests/:id/print-data) -->
            <div class="tab-pane fade" id="workflow-review" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-warning text-dark">ID Card Approval & Printing Gate (Principal Control)</div>
                    <div class="card-body">
                        
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Pending Requests</h5>
                            <button class="btn btn-sm btn-outline-primary" id="refreshRequestsBtn"><i class="bi bi-arrow-clockwise"></i> Refresh List</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Target Type</th>
                                        <th>Name (Mock)</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody">
                                    <tr><td colspan="5" class="text-center">Loading requests...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Approval Modal (for Principal/Admin) -->
                <div class="modal fade" id="approvalModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-card-checklist"></i> Review & Finalize Card Request</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body row">
                                <div class="col-md-6">
                                    <h6>Request Details (ID: <span id="modalRequestId"></span>)</h6>
                                    <ul class="list-unstyled small" id="modalRequestDetails"></ul>
                                    <button class="btn btn-sm btn-info mt-3" id="finalizeGenerateBtn"><i class="bi bi-send"></i> Submit for Approval Gate</button>
                                </div>
                                <div class="col-md-6">
                                    <h6>ID Card Preview</h6>
                                    <div id="cardPreviewContainer" class="d-flex justify-content-center">
                                        <!-- ID Card Preview will render here -->
                                        <div class="id-card">
                                            <div class="id-card-header">SCHOOL NAME / LOGO</div>
                                            <img src="https://placehold.co/100x100/3f51b5/ffffff?text=PHOTO" alt="Profile" class="id-photo">
                                            <div class="id-detail fw-bold text-center" id="previewName">N/A</div>
                                            <div class="id-detail text-center text-muted" id="previewTitle">N/A</div>
                                            <div class="id-detail mt-3">ID: <span id="previewEntityId">N/A</span></div>
                                            <div class="id-detail">Phone: <span id="previewPhone">N/A</span></div>
                                            <div class="id-barcode">
                                                <small>Barcode UID:</small>
                                                <div class="fw-bold" id="previewBarcode">N/A</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer justify-content-between">
                                <button class="btn btn-outline-success" id="principalApproveBtn" disabled><i class="bi bi-check-circle"></i> Principal Approve (Unlocks Print)</button>
                                <button class="btn btn-outline-danger" id="rejectBtn" disabled><i class="bi bi-x-circle"></i> Reject</button>
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Configuration Hub Tab (GET/PUT /config) -->
            <div class="tab-pane fade" id="config-setup" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-danger">ID Card Configuration & Compliance</div>
                    <div class="card-body">
                        <p class="alert alert-warning small"><i class="bi bi-lock-fill"></i> Access to configuration is restricted to **Admin/Principal** roles only.</p>
                        
                        <form id="configForm" class="row g-3">
                            <h5 class="text-danger">A. Design & Template Settings</h5>
                            <div class="col-md-6">
                                <label for="templateSelector" class="form-label">Card Template Version</label>
                                <select class="form-select" id="templateSelector" name="template">
                                    <option value="modern_student_v1">Modern Student (v1)</option>
                                    <option value="staff_compliance_v2">Staff Compliance (v2)</option>
                                    <option value="minimal_barcode_v3">Minimal Barcode (v3)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="barcodeStyle" class="form-label">Barcode Type for Attendance</label>
                                <select class="form-select" id="barcodeStyle" name="barcodeStyle">
                                    <option value="QR">QR Code (Attendance + Info)</option>
                                    <option value="Code128">Code 128 (Standard)</option>
                                </select>
                                <div class="form-text">Used by Attendance module for quick check-in.</div>
                            </div>

                            <hr class="my-3">
                            
                            <h5 class="text-danger">B. Compliance & Expiration Rules</h5>
                            <div class="col-md-6">
                                <label for="expirationPolicy" class="form-label">Card Expiration Policy</label>
                                <select class="form-select" id="expirationPolicy" name="expirationPolicy">
                                    <option value="12 months">12 Months (Standard)</option>
                                    <option value="academic_year_end">End of Academic Year (March 31)</option>
                                    <option value="24 months">24 Months (Staff)</option>
                                </select>
                                <div class="form-text">Sets the validity period before re-issuance is required.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="requiredFields" class="form-label">Mandatory Fields on Card (e.g., Name, Class, DOB)</label>
                                <input type="text" class="form-control" id="requiredFields" name="requiredFields" placeholder="name, class, dob, emergency_contact">
                                <div class="form-text">Comma-separated list used during data submission validation.</div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-danger btn-lg w-100" id="saveConfigBtn"><i class="bi bi-save"></i> Save Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Hidden Print Data Modal -->
            <div class="modal fade" id="printModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Authorized Print Data</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-success fw-bold">This data is ready for the printer (Status: APPROVED)</p>
                            <pre id="printDataContainer" class="bg-light p-3 border rounded small"></pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success"><i class="bi bi-printer"></i> Print ID Card</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        const MOCK_JWT_TOKEN = 'mock.jwt.token.for.auth'; 
        let currentRequests = [];

        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => { area.style.display = 'none'; }, 7000);
        }

        /** Core Fetch Function with JWT Auth Header. */
        async function apiFetch(endpoint, method = 'GET', body = null, isFormData = false) {
            try {
                const options = {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${MOCK_JWT_TOKEN}` 
                    },
                };
                
                if (body && method !== 'GET') {
                    if (!isFormData) {
                        options.headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    } else {
                        // For FormData, let the browser set Content-Type to boundary/multipart
                        options.body = body;
                    }
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error. Check console for details.', 'danger');
                throw error;
            }
        }
        
        // --- 1. REQUEST SUBMISSION LOGIC ---

        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submitRequestBtn');

            const payload = {
                targetEntityId: form.targetEntityId.value.trim(),
                userType: form.userType.value,
                name: form.fullName.value.trim(),
                cardTitle: form.cardTitle.value.trim(),
                contactPhone: form.contactPhone.value.trim(),
                emergencyContact: form.emergencyContact.value.trim(),
                dob: form.dob.value,
                // Additional data (mocked fields to ensure request_data is populated)
                address: "Mock Address Line 1",
                bloodGroup: "O+",
                issueDate: new Date().toISOString().split('T')[0]
            };
            
            // NOTE: The entire payload object goes into request_data in the DB

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

            try {
                const data = await apiFetch('/requests', 'POST', payload);
                showNotification(`Request submitted. Barcode UID generated: ${data.barcodeUid}. Request ID: ${data.request.id}`, 'success');
                
                // Automatically populate the photo upload form for the next step
                document.getElementById('requestIdUpload').value = data.request.id;
                form.reset();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-file-earmark-arrow-up"></i> Submit Data & Generate Barcode';
            }
        });

        document.getElementById('photoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('uploadPhotoBtn');
            const requestId = form.requestIdUpload.value.trim();
            
            if (!requestId) {
                showNotification('Please submit data first and paste the Request ID.', 'warning');
                return;
            }
            if (!form.profilePhoto.files[0]) {
                showNotification('Please select a photo file to upload.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('document', form.profilePhoto.files[0]);
            formData.append('documentType', 'profile_photo'); // Used by backend for JSONB update

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';

            try {
                // Mock endpoint POST /applications/:id/upload-document is used here
                const data = await apiFetch(`/applications/${requestId}/upload-document`, 'POST', formData, true);
                
                showNotification(`Photo uploaded successfully! The request is now ready for generation and Principal review.`, 'success');
                form.reset();
                form.requestIdUpload.value = requestId; // Keep ID present

                // Trigger refresh on the workflow tab
                fetchRequests();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-image"></i> Upload Photo & Finalize Request';
            }
        });

        // --- 2. APPROVAL WORKFLOW LOGIC ---

        async function fetchRequests() {
            const tableBody = document.getElementById('requestsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Fetching requests...</td></tr>';
            currentRequests = [];

            try {
                const data = await apiFetch('/requests');
                currentRequests = data.data;

                tableBody.innerHTML = '';
                if (currentRequests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No pending ID card requests.</td></tr>';
                    return;
                }

                currentRequests.forEach(req => {
                    const row = tableBody.insertRow();
                    const reqData = req.request_data;
                    const statusClass = {
                        'pending_data': 'bg-secondary',
                        'pending_approval': 'bg-warning text-dark',
                        'approved': 'bg-success',
                        'rejected': 'bg-danger'
                    }[req.status] || 'bg-light text-dark';

                    row.innerHTML = `
                        <td class="small">${req.id.substring(0, 8)}...</td>
                        <td>${req.target_entity_type.toUpperCase()}</td>
                        <td>${reqData.name || 'N/A'}</td>
                        <td><span class="badge ${statusClass}">${req.status.toUpperCase()}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary review-btn" data-bs-toggle="modal" data-bs-target="#approvalModal" data-request-id="${req.id}">Review</button>
                            ${req.status === 'approved' ? `<button class="btn btn-sm btn-success print-btn" data-request-id="${req.id}"><i class="bi bi-printer"></i> Print</button>` : ''}
                        </td>
                    `;
                });
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load requests.</td></tr>';
            }
        }

        // Handle Review Button Click (Populate Modal)
        document.getElementById('requestsTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('review-btn')) {
                const requestId = e.target.getAttribute('data-request-id');
                const request = currentRequests.find(r => r.id === requestId);
                if (!request) return;

                const data = request.request_data;
                document.getElementById('modalRequestId').textContent = requestId.substring(0, 12) + '...';
                document.getElementById('modalRequestDetails').innerHTML = `
                    <li><strong>Status:</strong> <span class="badge bg-warning text-dark">${request.status.toUpperCase()}</span></li>
                    <li><strong>Name:</strong> ${data.name || 'N/A'}</li>
                    <li><strong>Title:</strong> ${data.cardTitle || 'N/A'}</li>
                    <li><strong>Profile ID:</strong> ${request.target_entity_id}</li>
                    <li><strong>Barcode UID:</strong> ${data.barcodeUid || 'N/A'}</li>
                    <li><strong>Phone:</strong> ${data.contactPhone || 'N/A'}</li>
                    <li><strong>Photo Status:</strong> ${data.documents?.profile_photo?.uploaded ? '✅ Uploaded' : '❌ Pending'}</li>
                `;
                
                // Update Preview
                document.getElementById('previewName').textContent = data.name || 'N/A';
                document.getElementById('previewTitle').textContent = data.cardTitle || 'N/A';
                document.getElementById('previewEntityId').textContent = request.target_entity_id;
                document.getElementById('previewPhone').textContent = data.contactPhone || 'N/A';
                document.getElementById('previewBarcode').textContent = data.barcodeUid || 'N/A';
                
                // Set button states based on workflow status
                document.getElementById('finalizeGenerateBtn').style.display = request.status === 'pending_data' ? 'block' : 'none';
                document.getElementById('principalApproveBtn').disabled = request.status !== 'pending_approval';
                document.getElementById('rejectBtn').disabled = request.status === 'approved' || request.status === 'rejected';

                // Store current request ID on buttons
                document.getElementById('principalApproveBtn').setAttribute('data-request-id', requestId);
                document.getElementById('rejectBtn').setAttribute('data-request-id', requestId);
                document.getElementById('finalizeGenerateBtn').setAttribute('data-request-id', requestId);

            }
        });

        // Handle Finalize Generation Button (Admin Action)
        document.getElementById('finalizeGenerateBtn').addEventListener('click', async (e) => {
            const requestId = e.target.getAttribute('data-request-id');
            const btn = e.target;
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                const data = await apiFetch(`/requests/${requestId}/generate`, 'POST', {});
                showNotification(data.message, 'success');
                fetchRequests();
                bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
            } catch {
                btn.disabled = false;
                btn.textContent = 'Submit for Approval Gate';
            }
        });
        
        // Handle Principal Approval Button
        document.getElementById('principalApproveBtn').addEventListener('click', async (e) => {
            const requestId = e.target.getAttribute('data-request-id');
            const btn = e.target;
            btn.disabled = true;
            btn.textContent = 'Approving...';

            try {
                const data = await apiFetch(`/requests/${requestId}/approve`, 'POST', {});
                showNotification(data.message, 'success');
                fetchRequests();
                bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
            } catch {
                btn.disabled = false;
                btn.textContent = 'Principal Approve (Unlocks Print)';
            }
        });
        
        // Handle Print Button Click (Gated Access)
        document.getElementById('requestsTableBody').addEventListener('click', async (e) => {
            if (e.target.classList.contains('print-btn')) {
                const requestId = e.target.getAttribute('data-request-id');
                const btn = e.target;
                btn.disabled = true;
                btn.textContent = 'Fetching...';

                try {
                    const data = await apiFetch(`/requests/${requestId}/print-data`);
                    document.getElementById('printDataContainer').textContent = JSON.stringify(data, null, 2);
                    const printModal = new bootstrap.Modal(document.getElementById('printModal'));
                    printModal.show();
                    showNotification('Print data successfully retrieved (Status: APPROVED).', 'success');
                } catch (error) {
                    // API handles 403 (Not Approved) response
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-printer"></i> Print';
                }
            }
        });


        // --- 3. CONFIGURATION LOGIC ---
        
        async function fetchConfig() {
            try {
                const data = await apiFetch('/config');
                const settings = data.settings;
                
                document.getElementById('templateSelector').value = settings.template || 'modern_student_v1';
                document.getElementById('barcodeStyle').value = settings.barcode_style || 'QR';
                document.getElementById('expirationPolicy').value = settings.expiration_policy || '12 months';
                document.getElementById('requiredFields').value = settings.required_fields || 'name, class, dob, emergency_contact';
                
            } catch (error) {
                // Assuming defaults if API fails or 403 (Auth denied)
                showNotification('Configuration loaded with default fallback values (or access denied).', 'warning');
            }
        }
        
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveConfigBtn');
            
            const payload = {
                template: form.templateSelector.value,
                barcodeStyle: form.barcodeStyle.value,
                expirationPolicy: form.expirationPolicy.value,
                requiredFields: form.requiredFields.value.split(',').map(s => s.trim()).filter(s => s.length > 0),
                complianceSettings: { photoFormat: 'jpeg', resolution: '300dpi' } // Mock compliance data
            };

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message + ` New template: ${data.newTemplate}`, 'success');
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> Save Configuration';
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchRequests();
            fetchConfig();
            
            document.getElementById('refreshRequestsBtn').addEventListener('click', fetchRequests);
        });

    </script>
</body>
</html>
