<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ Admission Management System</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f4f8; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1200px; margin-top: 20px; }
        .card-header { background-color: #2c3e50; color: white; font-weight: bold; border-radius: 0.5rem 0.5rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); border-radius: 0.5rem; }
        .alert-fixed {
            position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .status-applied { background-color: #3498db; color: white; }
        .status-scheduled { background-color: #f1c40f; color: #333; }
        .status-admitted { background-color: #27ae60; color: white; }
        .status-rejected { background-color: #e74c3c; color: white; }
        .status-default { background-color: #bdc3c7; color: #333; }
        .history-item { font-size: 0.85rem; padding: 5px 0; border-bottom: 1px dashed #eee; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-primary"><i class="bi bi-person-fill-add"></i> Admission Management Dashboard</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="admissionTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab"><i class="bi bi-list-check"></i> Application Review</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="decision-tab" data-bs-toggle="tab" data-bs-target="#decision" type="button" role="tab"><i class="bi bi-check2-circle"></i> Decision Workflow</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab"><i class="bi bi-bar-chart-line"></i> Statistics & Bulk</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab"><i class="bi bi-gear-fill"></i> Configuration</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="public-portal-tab" data-bs-toggle="tab" data-bs-target="#public-portal" type="button" role="tab"><i class="bi bi-door-open"></i> Public Status Check</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="admissionTabContent">

            <!-- 1. Application Review Tab (GET /applications, File Upload) -->
            <div class="tab-pane fade show active" id="review" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Application List & Document Verification</div>
                    <div class="card-body">
                        
                        <!-- Statistics Summary (Inline) -->
                        <div id="review-stats-summary" class="row text-center mb-4">
                            <!-- Stats loaded dynamically -->
                        </div>

                        <!-- Application Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>App No.</th>
                                        <th>Applicant</th>
                                        <th>Applied Class</th>
                                        <th>Status</th>
                                        <th>Submitted On</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTableBody">
                                    <tr><td colspan="6" class="text-center">Loading applications...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Decision Workflow Tab (Document Verification, Scheduling, Final Decision) -->
            <div class="tab-pane fade" id="decision" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Application Workflow for: <span id="currentApplicantName" class="badge bg-light text-dark">Select Application</span></div>
                    <div class="card-body">
                        <div class="row">
                            
                            <!-- Document Verification Panel -->
                            <div class="col-md-6 border-end">
                                <h5>1. Document Verification & Upload</h5>
                                <p class="text-muted">Review, upload, and verify required documents.</p>
                                <div id="documentVerificationArea" class="mb-4">
                                    <p class="alert alert-warning">Please select an application from the 'Application Review' tab to begin the workflow.</p>
                                    <!-- Dynamic document list and verification buttons go here -->
                                </div>
                                
                                <!-- Document Upload Form -->
                                <h6 class="mt-4">Upload Supporting Document (Requires file selection)</h6>
                                <form id="documentUploadForm" class="input-group">
                                    <input type="hidden" id="uploadAppId">
                                    <select class="form-select" id="documentTypeSelect" required>
                                        <option value="">Select Document Type</option>
                                        <!-- Document options dynamically generated from config -->
                                    </select>
                                    <input type="file" class="form-control" name="document" id="documentFileInput" required>
                                    <button class="btn btn-secondary" type="submit" id="uploadDocBtn" disabled><i class="bi bi-upload"></i> Upload</button>
                                </form>
                            </div>

                            <!-- Scheduling & Final Decision Panel -->
                            <div class="col-md-6">
                                <h5>2. Scheduling & Final Decision</h5>
                                
                                <!-- Scheduling Form (POST /schedule) -->
                                <h6 class="mt-3">Schedule Interview/Assessment</h6>
                                <form id="scheduleForm" class="row g-2 mb-4">
                                    <input type="hidden" id="scheduleAppId">
                                    <div class="col-md-4"><select class="form-select" id="scheduleType" required><option value="interview">Interview</option><option value="assessment">Assessment</option></select></div>
                                    <div class="col-md-4"><input type="date" class="form-control" id="scheduleDate" required></div>
                                    <div class="col-md-4"><input type="time" class="form-control" id="scheduleTime" required></div>
                                    <div class="col-12"><button type="submit" class="btn btn-warning w-100" id="scheduleBtn" disabled><i class="bi bi-calendar-plus"></i> Schedule & Notify Parent</button></div>
                                </form>
                                
                                <hr>
                                
                                <!-- Final Decision Form (POST /admission-decision) -->
                                <h5 class="text-danger">3. Final Approval (Principal Only)</h5>
                                <form id="decisionForm" class="row g-3">
                                    <input type="hidden" id="decisionAppId">
                                    <div class="col-md-6"><label for="decisionClass" class="form-label">Allocated Class</label><input type="text" class="form-control" id="decisionClass" placeholder="e.g., 5th Grade" required></div>
                                    <div class="col-md-6"><label for="decisionSection" class="form-label">Allocated Section</label><input type="text" class="form-control" id="decisionSection" placeholder="e.g., A" required></div>
                                    <div class="col-12 d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-success btn-lg" id="admitBtn" data-decision="admitted" disabled><i class="bi bi-check-lg"></i> Admit</button>
                                        <button type="button" class="btn btn-danger btn-lg" id="rejectBtn" data-decision="rejected" disabled><i class="bi bi-x-lg"></i> Reject</button>
                                    </div>
                                    <div class="col-12 mt-3"><p id="decisionWarning" class="text-danger small">Final approval is a permanent action that creates a student record if Admitted.</p></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Statistics & Bulk Operations Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Admission Analytics & Bulk Tools</div>
                    <div class="card-body">

                        <!-- Statistics (GET /statistics) -->
                        <h5 class="mb-3">Admission Funnel Summary</h5>
                        <div id="statisticsArea" class="row text-center mb-5">
                            <div class="col-md-4"><div class="p-3 border rounded bg-light"><h4 class="text-primary" id="statTotal">...</h4><p class="text-muted">Total Applications</p></div></div>
                            <div class="col-md-4"><div class="p-3 border rounded bg-light"><h4 class="text-success" id="statAdmitted">...</h4><p class="text-muted">Admitted Students</p></div></div>
                            <div class="col-md-4"><div class="p-3 border rounded bg-light"><h4 class="text-warning" id="statConversion">...</h4><p class="text-muted">Conversion Rate</p></div></div>
                        </div>

                        <hr>
                        
                        <!-- Bulk Operations (POST /bulk/upload, GET /bulk/download) -->
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h5>Bulk Application Upload</h5>
                                <p class="text-muted">Upload CSV/Excel file for batch application entry.</p>
                                <form id="bulkUploadForm">
                                    <div class="mb-3"><input type="file" class="form-control" name="file" id="bulkFileInput" accept=".csv, .xlsx" required></div>
                                    <button type="submit" class="btn btn-primary" id="bulkUploadBtn"><i class="bi bi-file-earmark-arrow-up"></i> Start Bulk Upload</button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <h5>Data Export & Reporting</h5>
                                <p class="text-muted">Download comprehensive data sets for offline analysis.</p>
                                <button class="btn btn-secondary" id="bulkDownloadBtn"><i class="bi bi-file-earmark-arrow-down"></i> Export All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. Configuration Tab (Integrated GET/PUT /config) -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-secondary">System Configuration (Admission Manager Setup)</div>
                    <div class="card-body">
                        <p class="alert alert-info"><i class="bi bi-gear-fill"></i> Adjust key admission policies for the current academic cycle.</p>
                        
                        <form id="admissionConfigForm">
                            <h5 class="mt-4">Intake Cycle Setup</h5>
                            <div class="row g-3 mb-4 border p-3 rounded">
                                <div class="col-md-4">
                                    <label for="currentYear" class="form-label">Current Academic Year</label>
                                    <input type="text" class="form-control" id="currentYear" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="maxIntake" class="form-label">Maximum Intake Capacity</label>
                                    <input type="number" class="form-control" id="maxIntake" required min="1">
                                </div>
                                <div class="col-md-4">
                                    <label for="admissionStatus" class="form-label">Global Admission Status</label>
                                    <select class="form-select" id="admissionStatus">
                                        <option value="open">Open for Applications</option>
                                        <option value="closed">Closed for Applications</option>
                                        <option value="waitlist_only">Waitlist Only</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h5 class="mt-4">Document Verification Checklist</h5>
                            <div class="row g-3 mb-4 border p-3 rounded">
                                <div class="col-md-6">
                                    <label class="form-label">Required Documents (Checked = Mandatory):</label>
                                    <div id="requiredDocsChecklist">
                                        <!-- Checklist populated by JS from config -->
                                        <p class="text-muted">Loading documents list...</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="verificationThreshold" class="form-label">Required Verification Threshold (%)</label>
                                    <input type="number" class="form-control" id="verificationThreshold" min="0" max="100" required>
                                    <div class="form-text">Percentage of documents that must be verified for workflow progression.</div>
                                </div>
                            </div>

                            <h5 class="mt-4">Assessment & Notification Settings</h5>
                            <div class="row g-3 mb-4 border p-3 rounded">
                                <div class="col-md-6">
                                    <label for="minAssessmentScore" class="form-label">Min Assessment Score (%)</label>
                                    <input type="number" class="form-control" id="minAssessmentScore" min="0" max="100" required>
                                    <div class="form-text">Score below which a candidate is flagged for review.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="defaultNotificationPhone" class="form-label">Default Admission Notification Phone</label>
                                    <input type="text" class="form-control" id="defaultNotificationPhone" placeholder="+91..." required>
                                    <div class="form-text">Primary number used for Arattai/WhatsApp integration tests.</div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-secondary mt-3" id="saveAdmissionConfigBtn"><i class="bi bi-save"></i> Save Configuration</button>
                        </form>

                    </div>
                </div>
            </div>

            <!-- 5. Public Status Check Portal (GET /portal/:applicationNumber) -->
            <div class="tab-pane fade" id="public-portal" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-info">Application Status Portal</div>
                    <div class="card-body">
                        <p class="alert alert-info">Enter the application number to check the current status and history.</p>
                        
                        <form id="statusCheckForm" class="input-group mb-4">
                            <input type="text" class="form-control" id="checkAppNumber" placeholder="Enter Application Number (e.g., ADM20241234)" required>
                            <button class="btn btn-info" type="submit" id="checkStatusBtn"><i class="bi bi-search"></i> Check Status</button>
                        </form>

                        <div id="portalResultArea" class="mt-4 p-3 border rounded bg-light" style="min-height: 150px;">
                            <h5 id="portalStatusDisplay" class="mb-3"></h5>
                            <p id="portalApplicantName"></p>
                            <h6>Application History:</h6>
                            <div id="portalHistoryList"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        let currentSelectedApplication = null;
        let globalAdmissionConfig = {}; // Stores fetched configuration

        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => {
                area.style.display = 'none';
            }, 7000);
        }
        
        // Helper function to replace window.confirm (as alerts are blocked)
        function customConfirm(message) {
            return window.prompt(message + " (Type 'YES' to proceed)") === 'YES';
        }

        /** Core Fetch Function with Error Handling. */
        async function apiFetch(endpoint, method = 'GET', body = null, isFormData = false) {
            try {
                const options = { method: method };
                
                if (!isFormData) {
                    options.headers = { 'Content-Type': 'application/json' };
                    if (body && method !== 'GET') { options.body = JSON.stringify(body); }
                } else if (body && method !== 'GET') {
                    options.body = body;
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error.', 'danger');
                throw error;
            }
        }

        // --- STATUS & HISTORY HELPERS ---
        function getStatusBadge(status) {
            const normalizedStatus = status.toLowerCase().replace(/[^a-z]/g, '');
            const statusClass = normalizedStatus.includes('scheduled') ? 'scheduled' : 
                                normalizedStatus.includes('admitted') ? 'admitted' :
                                normalizedStatus.includes('rejected') ? 'rejected' : 
                                normalizedStatus.includes('applied') ? 'applied' : 'default';

            return `<span class="badge status-${statusClass}">${status.toUpperCase()}</span>`;
        }
        
        function formatHistory(historyJson) {
            let history;
            try {
                history = JSON.parse(historyJson);
            } catch (e) {
                history = historyJson; 
            }
            
            if (!Array.isArray(history)) return '<p class="text-muted">No history recorded.</p>';
            
            return history.map(item => {
                const date = new Date(item.timestamp).toLocaleString();
                let details = item.doc ? `(${item.doc})` : (item.date ? `(${item.date} @ ${item.time})` : '');
                
                return `<div class="history-item"><strong>${item.status.toUpperCase()}</strong> ${details} by ${item.actor} on ${date}</div>`;
            }).join('');
        }
        
        // --- CONFIGURATION LOGIC (GET/PUT /config) ---

        async function fetchConfig() {
            try {
                const data = await apiFetch('/config');
                const settings = data.settings;
                globalAdmissionConfig = settings;

                // 1. Populate form fields
                document.getElementById('currentYear').value = settings.currentYear || '';
                document.getElementById('maxIntake').value = settings.maxIntake || 0;
                document.getElementById('admissionStatus').value = settings.admissionStatus || 'open';
                document.getElementById('verificationThreshold').value = settings.verificationThreshold || 100;
                document.getElementById('minAssessmentScore').value = settings.minAssessmentScore || 70;
                document.getElementById('defaultNotificationPhone').value = settings.defaultNotificationPhone || '';
                
                // 2. Render Document Checklist
                renderDocumentChecklist(settings.requiredDocs);
                
                // 3. Update Document Upload Select Options
                renderDocumentUploadOptions(settings.requiredDocs);

            } catch (error) {
                 console.error("Configuration fetch failed:", error);
                 showNotification("Failed to load configuration. Using defaults.", 'danger');
            }
        }
        
        function renderDocumentChecklist(requiredDocs) {
            const listDiv = document.getElementById('requiredDocsChecklist');
            listDiv.innerHTML = '';
            
            const standardDocs = [
                { key: 'birth_certificate', label: 'Birth Certificate' },
                { key: 'mark_sheet', label: 'Previous Mark Sheet' },
                { key: 'photo', label: 'Passport Size Photo' },
                { key: 'transfer_certificate', label: 'Transfer Certificate' }
            ];

            standardDocs.forEach(doc => {
                const checked = requiredDocs.includes(doc.key) ? 'checked' : '';
                listDiv.innerHTML += `
                    <div class="form-check">
                        <input class="form-check-input required-doc-checkbox" type="checkbox" id="doc-${doc.key}" value="${doc.key}" ${checked}>
                        <label class="form-check-label" for="doc-${doc.key}">${doc.label}</label>
                    </div>
                `;
            });
        }
        
        function renderDocumentUploadOptions(requiredDocs) {
            const select = document.getElementById('documentTypeSelect');
            select.innerHTML = '<option value="">Select Document Type</option>';
            
            requiredDocs.forEach(docKey => {
                select.innerHTML += `<option value="${docKey}">${docKey.replace(/_/g, ' ').toUpperCase()}</option>`;
            });
        }


        document.getElementById('admissionConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveAdmissionConfigBtn');
            btn.disabled = true;

            // Collect required documents from checked boxes
            const requiredDocs = Array.from(document.querySelectorAll('.required-doc-checkbox:checked')).map(cb => cb.value);

            const payload = {
                currentYear: form.currentYear.value,
                maxIntake: parseInt(form.maxIntake.value),
                admissionStatus: form.admissionStatus.value,
                verificationThreshold: parseInt(form.verificationThreshold.value),
                minAssessmentScore: parseInt(form.minAssessmentScore.value),
                defaultNotificationPhone: form.defaultNotificationPhone.value,
                requiredDocs: requiredDocs
            };
            
            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message, 'success');
                fetchConfig(); // Reload config to confirm changes
            } catch (error) {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });


        // --- 1. APPLICATION REVIEW LOGIC ---

        async function fetchApplications() {
            const tableBody = document.getElementById('applicationsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading applications...</td></tr>';
            
            try {
                const data = await apiFetch('/applications');
                
                tableBody.innerHTML = '';
                if (data.applications.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No admission applications found.</td></tr>';
                    return;
                }
                
                data.applications.forEach(app => {
                    const appliedClass = app.application_data?.appliedForClass || 'N/A';
                    const createdAt = new Date(app.created_at).toLocaleDateString();

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${app.application_number}</td>
                        <td>${app.applicant_name}</td>
                        <td>${appliedClass}</td>
                        <td>${getStatusBadge(app.admission_status)}</td>
                        <td>${createdAt}</td>
                        <td><button class="btn btn-sm btn-primary review-app-btn" data-id="${app.id}" data-app-data='${JSON.stringify(app)}'><i class="bi bi-arrow-right-circle"></i> Review</button></td>
                    `;
                });
                
                fetchStatistics(); // Update stats immediately after fetching apps

            } catch {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load applications.</td></tr>';
            }
        }
        
        // Handle 'Review' button click to populate the Decision tab
        document.getElementById('applicationsTableBody').addEventListener('click', (e) => {
            const button = e.target.closest('.review-app-btn');
            if (button) {
                const appData = JSON.parse(button.getAttribute('data-app-data'));
                currentSelectedApplication = appData;
                
                // Set UI context
                document.getElementById('currentApplicantName').textContent = `${appData.applicant_name} (${appData.application_number})`;
                document.getElementById('uploadAppId').value = appData.id;
                document.getElementById('scheduleAppId').value = appData.id;
                document.getElementById('decisionAppId').value = appData.id;
                
                // Enable forms
                document.getElementById('uploadDocBtn').disabled = false;
                document.getElementById('scheduleBtn').disabled = false;
                document.getElementById('admitBtn').disabled = false;
                document.getElementById('rejectBtn').disabled = false;

                renderDocumentVerification(appData.id, appData.application_data);

                // Switch to decision tab
                const decisionTabBtn = document.getElementById('decision-tab');
                const bsTab = new bootstrap.Tab(decisionTabBtn);
                bsTab.show();
            }
        });

        // --- 2. DECISION WORKFLOW LOGIC ---

        function renderDocumentVerification(appId, appData) {
            const area = document.getElementById('documentVerificationArea');
            const requiredDocs = globalAdmissionConfig.requiredDocs || [];
            const documentMap = {};
            
            requiredDocs.forEach(docType => {
                documentMap[docType] = appData?.application_data?.documents?.[docType] || {};
            });
            
            let html = '<ul class="list-group">';
            
            if (Object.keys(documentMap).length === 0) {
                 html = '<p class="alert alert-warning">No mandatory documents defined in configuration.</p>';
            } else {
                 for (const docType in documentMap) {
                    const doc = documentMap[docType];
                    const uploaded = doc.uploaded || false;
                    const verified = doc.verified || false;
                    const statusText = uploaded ? (verified ? 'Verified' : 'Review Required') : 'Missing';
                    const statusClass = verified ? 'text-success' : (uploaded ? 'text-warning' : 'text-danger');
                    
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${docType.replace(/_/g, ' ').toUpperCase()}
                            <span class="${statusClass} small fw-bold">${statusText}</span>
                            <div>
                                ${uploaded ? `<button class="btn btn-sm btn-outline-success verify-doc-btn" data-id="${appId}" data-type="${docType}" data-verified="true" ${verified ? 'disabled' : ''}>Verify</button> ` : ''}
                                ${uploaded && !verified ? `<button class="btn btn-sm btn-outline-danger verify-doc-btn" data-id="${appId}" data-type="${docType}" data-verified="false">Reject</button>` : ''}
                                ${uploaded && doc.path ? `<a href="${doc.path}" target="_blank" class="btn btn-sm btn-info ms-2"><i class="bi bi-eye"></i> View</a>` : ''}
                            </div>
                        </li>
                    `;
                }
                html += '</ul>';
            }
            area.innerHTML = html;
        }

        // POST Document Upload
        document.getElementById('documentUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const appId = document.getElementById('uploadAppId').value;
            const docType = document.getElementById('documentTypeSelect').value;
            
            const formData = new FormData(form);
            formData.append('documentType', docType);

            const btn = document.getElementById('uploadDocBtn');
            btn.disabled = true;

            try {
                const data = await apiFetch(`/applications/${appId}/upload-document`, 'POST', formData, true);
                showNotification(data.message, 'success');
                fetchApplications(); // Refresh table to get updated app data
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });
        
        // POST Document Verification
        document.getElementById('documentVerificationArea').addEventListener('click', async (e) => {
            const button = e.target.closest('.verify-doc-btn');
            if (button) {
                const appId = button.getAttribute('data-id');
                const docType = button.getAttribute('data-type');
                const isVerified = button.getAttribute('data-verified') === 'true';

                try {
                    const data = await apiFetch(`/applications/${appId}/verify-document`, 'POST', { documentType: docType, isVerified: isVerified });
                    showNotification(data.message, 'success');
                    fetchApplications(); // Refresh list to get updated status
                } catch {
                    // Error handled by apiFetch
                }
            }
        });
        
        // POST Schedule Assessment/Interview
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const appId = document.getElementById('scheduleAppId').value;

            const payload = {
                scheduleType: form.scheduleType.value,
                date: form.scheduleDate.value,
                time: form.scheduleTime.value
            };
            
            const btn = document.getElementById('scheduleBtn');
            btn.disabled = true;

            try {
                const data = await apiFetch(`/applications/${appId}/schedule`, 'POST', payload);
                showNotification(data.message, 'success');
                fetchApplications(); // Refresh list to see status change
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });
        
        // POST Final Admission Decision (Admit/Reject)
        document.getElementById('decisionForm').addEventListener('click', async (e) => {
            const decisionBtn = e.target.closest('button[data-decision]');
            if (!decisionBtn) return;
            
            const decision = decisionBtn.getAttribute('data-decision');
            const appId = document.getElementById('decisionAppId').value;
            const allocatedClass = document.getElementById('decisionClass').value;
            const allocatedSection = document.getElementById('decisionSection').value;

            if (decision === 'admitted' && (!allocatedClass || !allocatedSection)) {
                showNotification("Allocated Class and Section are required for admission.", 'warning');
                return;
            }
            
            if (!customConfirm(`Confirm final decision: ${decision.toUpperCase()}? This action is permanent and creates a student record if Admitted.`)) return;

            decisionBtn.disabled = true;

            const payload = { decision, allocatedClass, allocatedSection };
            
            try {
                const data = await apiFetch(`/applications/${appId}/admission-decision`, 'POST', payload);
                showNotification(data.message, 'success');
                fetchApplications(); // Refresh list
            } catch {
                // Error handled by apiFetch
            } finally {
                decisionBtn.disabled = false;
            }
        });


        // --- 3. STATISTICS & BULK OPERATIONS LOGIC ---

        async function fetchStatistics() {
            try {
                const data = await apiFetch('/statistics');
                const summary = data.summary;
                
                document.getElementById('statTotal').textContent = summary.totalApplications;
                document.getElementById('statAdmitted').textContent = summary.admitted;
                document.getElementById('statConversion').textContent = summary.conversionRate;
                
                // Update inline review stats summary (mocking a simple view here)
                document.getElementById('review-stats-summary').innerHTML = `
                    <div class="col-md-3"><div class="p-2 border rounded bg-light"><strong>Total:</strong> ${summary.totalApplications}</div></div>
                    <div class="col-md-3"><div class="p-2 border rounded status-admitted"><strong>Admitted:</strong> ${summary.admitted}</div></div>
                    <div class="col-md-3"><div class="p-2 border rounded status-rejected"><strong>Rejected:</strong> ${summary.rejected}</div></div>
                    <div class="col-md-3"><div class="p-2 border rounded status-applied"><strong>Pending:</strong> ${summary.totalApplications - summary.admitted - summary.rejected}</div></div>
                `;

            } catch (error) {
                console.error("Stats fetch error:", error);
            }
        }

        // POST Bulk Upload
        document.getElementById('bulkUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const btn = document.getElementById('bulkUploadBtn');
            btn.disabled = true;

            try {
                const data = await apiFetch('/bulk/upload', 'POST', formData, true);
                showNotification(data.message, 'success');
                form.reset();
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });
        
        // GET Bulk Download
        document.getElementById('bulkDownloadBtn').addEventListener('click', async () => {
            const btn = document.getElementById('bulkDownloadBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initiating...';
            
            try {
                const data = await apiFetch('/bulk/download');
                showNotification(data.message, 'info');
            } catch {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // --- 5. PUBLIC STATUS CHECK LOGIC ---
        
        document.getElementById('statusCheckForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const appNumber = document.getElementById('checkAppNumber').value;
            const resultArea = document.getElementById('portalResultArea');
            const statusDisplay = document.getElementById('portalStatusDisplay');
            const historyList = document.getElementById('portalHistoryList');
            
            resultArea.classList.add('bg-light');
            statusDisplay.textContent = 'Searching...';
            historyList.innerHTML = '';
            
            try {
                const data = await apiFetch(`/portal/${appNumber}`);
                
                const currentStatus = data.status || 'N/A';
                const applicantName = data.details?.studentName || 'Applicant Details Unavailable';
                
                statusDisplay.innerHTML = `Current Status: ${getStatusBadge(currentStatus)}`;
                document.getElementById('portalApplicantName').textContent = `Applicant: ${applicantName}`;
                historyList.innerHTML = formatHistory(data.history);
                
                if (currentStatus === 'admitted') {
                    resultArea.classList.remove('bg-light');
                    resultArea.style.backgroundColor = '#ecf8e9'; // Light green for admitted
                } else {
                    resultArea.style.backgroundColor = '';
                }

            } catch (error) {
                statusDisplay.innerHTML = `<span class="badge bg-danger">Error / Not Found</span>`;
                document.getElementById('portalApplicantName').textContent = `Error: ${error.message}`;
                historyList.innerHTML = '<p class="text-muted">Could not retrieve application history.</p>';
            }
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date/time for scheduling form
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('scheduleDate').value = today;
            document.getElementById('scheduleTime').value = '10:00';
            
            fetchConfig();
            fetchApplications();
        });
    </script>
</body>
</html>
