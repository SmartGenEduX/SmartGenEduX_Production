<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… Attendance Management System - Ultimate Enterprise</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f5f8fa; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1200px; margin-top: 20px; }
        .card-header { background-color: #3f51b5; color: white; font-weight: bold; border-radius: 0.5rem 0.5rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .alert-fixed {
            position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #3f51b5;
            color: white;
            border-color: #3f51b5;
        }
        .stat-box { transition: transform 0.2s; cursor: default; }
        .stat-box:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .status-present { background-color: #4CAF50; }
        .status-absent { background-color: #F44336; }
        .status-late { background-color: #FFC107; color: #333; }
        .btn-status { color: white; border: none; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="text-center mb-4 text-primary"><i class="bi bi-calendar-check"></i> Attendance Module</h1>

        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="attendanceTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button"><i class="bi bi-clock"></i> Daily Operations</button></li>
            <li class="nav-item"><button class="nav-link" id="teacher-tab" data-bs-toggle="tab" data-bs-target="#teacher" type="button"><i class="bi bi-person-badge"></i> Teacher Check-In</button></li>
            <li class="nav-item"><button class="nav-link" id="barcode-tab" data-bs-toggle="tab" data-bs-target="#barcode" type="button"><i class="bi bi-qr-code-scan"></i> Student Attendance</button></li>
            <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"><i class="bi bi-gear-fill"></i> Configuration & Payroll</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="attendanceTabContent">

            <!-- 1. Daily Operations Tab (GET /summary/today, POST /mark/student/:id) -->
            <div class="tab-pane fade show active" id="daily" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Today's Attendance Overview</div>
                    <div class="card-body">
                        
                        <!-- Summary Stats -->
                        <div class="row text-center g-3 mb-4" id="dailySummaryStats">
                            <!-- Stats dynamically loaded -->
                        </div>

                        <!-- Manual Student Marking -->
                        <h5 class="mt-4 mb-3">Manual Student Attendance Marking (Teacher/Admin)</h5>
                        <form id="manualMarkForm" class="row g-3 border p-3 rounded bg-light">
                            <div class="col-md-3">
                                <label for="manualStudentId" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="manualStudentId" placeholder="e.g., STD1001" required>
                            </div>
                            <div class="col-md-3">
                                <label for="manualClassId" class="form-label">Class ID</label>
                                <input type="text" class="form-control" id="manualClassId" placeholder="e.g., 10-A" required>
                            </div>
                            <div class="col-md-3">
                                <label for="manualDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="manualDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="manualTimeIn" class="form-label">Time In (HH:MM)</label>
                                <input type="time" class="form-control" id="manualTimeIn" required>
                            </div>
                            
                            <div class="col-md-8">
                                <label for="manualNotes" class="form-label">Notes/Remarks</label>
                                <input type="text" class="form-control" id="manualNotes" placeholder="e.g., Absent due to fever">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-status status-present" data-status="present" data-action="mark">Present</button>
                                    <button type="button" class="btn btn-status status-absent" data-status="absent" data-action="mark">Absent</button>
                                    <button type="button" class="btn btn-status status-late" data-status="late" data-action="mark">Late</button>
                                </div>
                            </div>
                            <div class="col-12"><p class="text-danger small" id="manualMarkError"></p></div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 2. Teacher Check-In Tab (POST /teachers/mark/:id) -->
            <div class="tab-pane fade" id="teacher" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Teacher Secure Check-In (Biometric & GPS)</div>
                    <div class="card-body">
                        <p class="alert alert-success"><i class="bi bi-link-45deg"></i> **Simulated Link Check-In:** The system sends a secure link (30 mins before start/at end) to the teacher's registered mobile number. Opening the link triggers this process.</p>
                        
                        <form id="teacherMarkForm" class="row g-3 border p-3 rounded bg-light">
                            <div class="col-md-4">
                                <label for="teacherProfileId" class="form-label">Teacher Profile ID</label>
                                <input type="text" class="form-control" id="teacherProfileId" placeholder="e.g., TEACHER_005" required>
                            </div>
                            <div class="col-md-4">
                                <label for="teacherLocationSelect" class="form-label">Check-in Location</label>
                                <select class="form-select" id="teacherLocationSelect" required>
                                    <option value="">Select Pre-set Location</option>
                                    <!-- Options loaded from config -->
                                </select>
                                <div class="form-text">Choose the site where you are currently on duty.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="biometricToken" class="form-label">Biometric Token (Simulated)</label>
                                <input type="password" class="form-control" id="biometricToken" placeholder="Enter OTP/Token" required>
                                <div class="form-text">Simulates Fingerprint/Face ID verification.</div>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Simulated GPS Capture (Overridden by Selected Location)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="teacherLat" placeholder="Latitude (Captured)" readonly>
                                    <input type="text" class="form-control" id="teacherLon" placeholder="Longitude (Captured)" readonly>
                                </div>
                                <div class="form-text text-danger" id="geofenceStatus">Status: GPS coordinates locked to selected pre-set location.</div>
                            </div>

                            <div class="col-12 d-flex justify-content-center pt-3">
                                <button type="button" class="btn btn-lg btn-status status-present" data-status="present" data-action="mark-teacher"><i class="bi bi-fingerprint"></i> Check-In (Present)</button>
                            </div>
                            <div class="col-12 text-center pt-2">
                                <p class="text-danger small">Late status is determined automatically by time. Check-Out uses the same button sharp at end time.</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 3. Barcode Simulation Tab (POST /mark/barcode) -->
            <div class="tab-pane fade" id="barcode" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header">Student Attendance Marking (Via Teacher/Admin Mobile)</div>
                    <div class="card-body">
                        <p class="alert alert-info"><i class="bi bi-mobile"></i> **Teacher/Admin Action:** Use your mobile device to scan the student's ID card barcode. The system records the student's ID, the time, and **YOUR mobile location**.</p>

                        <form id="barcodeMarkForm" class="row g-3 border p-3 rounded bg-light">
                            <div class="col-md-6">
                                <label for="barcodeUid" class="form-label">Barcode/QR UID (Student ID Card)</label>
                                <input type="text" class="form-control" id="barcodeUid" placeholder="e.g., BC456789" required>
                                <div class="form-text">Simulates the mobile camera scan.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="barcodeTimeIn" class="form-label">Simulated Scan Time</label>
                                <input type="time" class="form-control" id="barcodeTimeIn" required>
                                <div class="form-text">Used to determine 'Present' or 'Late' status against school start time.</div>
                            </div>
                            
                            <div class="col-12">
                                <h6 class="mt-3">Location Capture (Teacher/Admin Device GPS)</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="barcodeLat" placeholder="Latitude (Current Location)" required>
                                    <input type="text" class="form-control" id="barcodeLon" placeholder="Longitude (Current Location)" required>
                                    <button type="button" class="btn btn-outline-secondary" id="getCurrentLocationBtn"><i class="bi bi-geo-alt"></i> Get GPS</button>
                                </div>
                                <div class="form-text">Records the location where the attendance was marked (e.g., the classroom).</div>
                            </div>

                            <div class="col-12 pt-3">
                                <button type="submit" class="btn btn-primary w-100" id="scanBarcodeBtn"><i class="bi bi-qr-code"></i> Record Student Attendance</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 4. Configuration & Payroll Tab (GET/PUT /config) -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-danger">Attendance Rules & Payroll Integration (Admin/Principal Only)</div>
                    <div class="card-body">
                        <form id="attendanceConfigForm">
                            <h5 class="mt-2">I. School Timing & Auto-Marking</h5>
                            <div class="row g-3 mb-4 border p-3 rounded">
                                <div class="col-md-4">
                                    <label for="startTime" class="form-label">Official School Start Time</label>
                                    <input type="time" class="form-control" id="startTime" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="lateThreshold" class="form-label">Late Threshold (Minutes)</label>
                                    <input type="number" class="form-control" id="lateThreshold" required min="1" max="60">
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <div class="form-check form-switch pt-4">
                                        <input class="form-check-input" type="checkbox" id="autoMarkAbsentEnabled">
                                        <label class="form-check-label" for="autoMarkAbsentEnabled">Auto-Mark Absent at EOD</label>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mt-4">II. Teacher Flexible Location Setup (3 Pre-set Spots)</h5>
                            <div class="row g-3 mb-4 border p-3 rounded">
                                <div class="col-12"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="geofenceEnabled"><label class="form-check-label" for="geofenceEnabled">Enable Geofence Enforcement (For all locations)</label></div></div>
                                
                                <div class="col-md-4">
                                    <label for="geofenceRadius" class="form-label">Geofence Radius (Meters)</label>
                                    <input type="number" class="form-control" id="geofenceRadius" required min="10" max="500">
                                    <div class="form-text">Radius around *any* selected location.</div>
                                </div>

                                <h6 class="mt-3">Location 1 (Default/Main Campus)</h6>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc1Name" placeholder="Location Name" value="Main Campus"></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="geofenceLat" placeholder="Latitude" required></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="geofenceLon" placeholder="Longitude" required></div>
                                
                                <h6 class="mt-3">Location 2 (e.g., Sports Ground)</h6>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc2Name" placeholder="Location Name" value="Sports Ground"></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc2Lat" placeholder="Latitude"></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc2Lon" placeholder="Longitude"></div>
                                
                                <h6 class="mt-3">Location 3 (e.g., Auditorium/Field Trip)</h6>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc3Name" placeholder="Location Name" value="Auditorium"></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc3Lat" placeholder="Latitude"></div>
                                <div class="col-md-3"><input type="text" class="form-control" id="loc3Lon" placeholder="Longitude"></div>

                            </div>

                            <h5 class="mt-4 text-danger">III. Payroll & Leave Conversion Rules</h5>
                            <p class="text-danger small">These rules integrate directly with the Accounts/Leave Management module to penalize frequent late marks.</p>
                            <div class="row g-3 mb-4 border border-danger p-3 rounded">
                                <div class="col-md-4">
                                    <label for="maxLate" class="form-label">Maximum Allowed Late Entries</label>
                                    <input type="number" class="form-control" id="maxLate" required min="1" max="30">
                                    <div class="form-text">Total late marks allowed before conversion starts. (e.g., 6)</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="lateToPerm" class="form-label">Late to Permission Conversion Factor</label>
                                    <input type="number" class="form-control" id="lateToPerm" required min="1" max="100">
                                    <div class="form-text">X late marks = 1 Permission (e.g., 6 lates = 1 perm)</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="permToHalf" class="form-label">Permission to Half-Day Leave Factor</label>
                                    <input type="number" class="form-control" id="permToHalf" required min="1" max="100">
                                    <div class="form-text">Y Permissions = 0.5 Day Leave (e.g., 8 perms = 0.5 day)</div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-danger mt-3" id="saveConfigBtn"><i class="bi bi-save"></i> Save All Attendance & Payroll Settings</button>
                        </form>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        let globalLocations = []; // Store configured locations for use in the teacher check-in form
        
        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => {
                area.style.display = 'none';
            }, 7000);
        }

        /** Core Fetch Function with Error Handling. */
        async function apiFetch(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error.', 'danger');
                throw error;
            }
        }

        /** Helper to get actual GPS coordinates for the current device */
        function getCurrentLocation(latInput, lonInput) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        latInput.value = position.coords.latitude.toFixed(6);
                        lonInput.value = position.coords.longitude.toFixed(6);
                        showNotification("GPS captured successfully!", 'info');
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showNotification("Failed to capture GPS. Please input manually.", 'warning');
                        latInput.value = '';
                        lonInput.value = '';
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showNotification("Geolocation is not supported by this browser.", 'warning');
            }
        }
        
        // --- 1. DAILY OPERATIONS LOGIC ---
        
        async function fetchAttendanceSummary() {
            const statsArea = document.getElementById('dailySummaryStats');
            statsArea.innerHTML = '<div class="col-12 text-center text-muted">Fetching summary...</div>';

            try {
                const summary = await apiFetch('/summary/today');
                
                const absentPercent = summary.totalStudents > 0 ? ((summary.absent / summary.totalStudents) * 100).toFixed(1) : 0;
                
                statsArea.innerHTML = `
                    <div class="col-md-3"><div class="p-3 border rounded bg-light stat-box"><h4 class="text-primary">${summary.totalStudents.toLocaleString()}</h4><p class="text-muted">Total Enrolled Students</p></div></div>
                    <div class="col-md-3"><div class="p-3 border rounded bg-light stat-box"><h4 class="status-present text-white">${summary.present.toLocaleString()}</h4><p class="text-muted">Present (On-Time + Late)</p></div></div>
                    <div class="col-md-3"><div class="p-3 border rounded bg-light stat-box"><h4 class="status-absent text-white">${summary.absent.toLocaleString()}</h4><p class="text-muted">Absent Students</p></div></div>
                    <div class="col-md-3"><div class="p-3 border rounded bg-light stat-box"><h4 class="text-success">${summary.attendanceRate}%</h4><p class="text-muted">Attendance Rate (${absentPercent}% Absent)</p></div></div>
                `;
            } catch (error) {
                statsArea.innerHTML = '<div class="col-12 text-center text-danger">Failed to load daily summary.</div>';
            }
        }

        // Student Manual Marking Logic
        document.getElementById('manualMarkForm').addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action="mark"]');
            if (!button) return;

            const form = document.getElementById('manualMarkForm');
            const studentId = form.manualStudentId.value;
            const classId = form.manualClassId.value;
            const date = form.manualDate.value;
            const timeIn = form.manualTimeIn.value;
            const status = button.getAttribute('data-status');
            const notes = form.manualNotes.value;
            
            document.getElementById('manualMarkError').textContent = '';

            if (!studentId || !classId || !date || !timeIn) {
                document.getElementById('manualMarkError').textContent = "Please fill in Student ID, Class ID, Date, and Time.";
                return;
            }

            const payload = {
                date,
                status,
                timeIn,
                classId,
                notes,
                method: 'manual',
            };

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const data = await apiFetch(`/mark/student/${studentId}`, 'POST', payload);
                showNotification(data.message, 'success');
                form.reset();
                fetchAttendanceSummary();
            } catch (error) {
                // Error handled by apiFetch
            } finally {
                button.disabled = false;
                button.innerHTML = status.charAt(0).toUpperCase() + status.slice(1);
            }
        });
        
        // --- 2. TEACHER CHECK-IN LOGIC ---

        function populateTeacherLocations() {
            const select = document.getElementById('teacherLocationSelect');
            select.innerHTML = '<option value="">Select Pre-set Location</option>';
            
            if (globalLocations.length === 0) {
                 select.innerHTML += '<option value="" disabled>No locations configured yet.</option>';
                 return;
            }

            globalLocations.forEach((loc, index) => {
                if (loc.lat && loc.lon) {
                    select.innerHTML += `<option value="${index}" data-lat="${loc.lat}" data-lon="${loc.lon}">${loc.name}</option>`;
                }
            });
        }

        document.getElementById('teacherLocationSelect').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const lat = selectedOption.getAttribute('data-lat');
            const lon = selectedOption.getAttribute('data-lon');
            
            document.getElementById('teacherLat').value = lat || '';
            document.getElementById('teacherLon').value = lon || '';
        });
        
        document.getElementById('teacherMarkForm').addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action="mark-teacher"]');
            if (!button) return;

            const form = document.getElementById('teacherMarkForm');
            const teacherProfileId = form.teacherProfileId.value;
            const selectedLocationIndex = form.teacherLocationSelect.value;
            const biometricToken = form.biometricToken.value;
            const date = form.teacherDate.value;
            const timeIn = form.teacherTimeIn.value;
            
            const latitude = form.teacherLat.value;
            const longitude = form.teacherLon.value;
            const notes = 'Checked in from ' + form.teacherLocationSelect.options[form.teacherLocationSelect.selectedIndex].text; // Fixed note

            if (!teacherProfileId || !selectedLocationIndex || !biometricToken) {
                showNotification("Teacher ID, Location, and Biometric Token are required.", 'warning');
                return;
            }
            if (!latitude || !longitude) {
                showNotification("Selected location is missing GPS coordinates. Please check configuration.", 'danger');
                return;
            }
            
            // NOTE: Status is simplified to 'present' initially, the backend will determine 'late' based on timeIn vs. startTime.
            const status = 'present'; 

            const payload = { 
                date, 
                status, 
                timeIn, 
                notes, 
                latitude, 
                longitude 
            };

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const data = await apiFetch(`/teachers/mark/${teacherProfileId}`, 'POST', payload);
                
                if (data.geofenceAlertTriggered) {
                    showNotification("Mark recorded, but **GEOFENCE VIOLATION DETECTED!** Principal/Admin alerted.", 'danger');
                } else {
                    // NOTE: The backend logic for teachers determines late/present based on time, and triggers leave conversion.
                    const finalStatus = data.record.status || 'Present';
                    showNotification(`Teacher Check-In recorded as: **${finalStatus.toUpperCase()}**.`, 'success');
                }

                form.reset();
                populateTeacherLocations(); // Reset dropdown
            } catch (error) {
                // Error handled by apiFetch
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-fingerprint"></i> Check-In (Present)';
            }
        });
        
        // --- 3. BARCODE SIMULATION LOGIC ---
        
        document.getElementById('getCurrentLocationBtn').addEventListener('click', () => {
             getCurrentLocation(document.getElementById('barcodeLat'), document.getElementById('barcodeLon'));
        });

        document.getElementById('barcodeMarkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const barcodeUid = form.barcodeUid.value;
            const timeIn = form.barcodeTimeIn.value;
            const latitude = form.barcodeLat.value;
            const longitude = form.barcodeLon.value;
            const btn = document.getElementById('scanBarcodeBtn');
            btn.disabled = true;

            if (!latitude || !longitude) {
                showNotification("Please capture or input the Teacher/Admin device location.", 'warning');
                btn.disabled = false;
                return;
            }

            const payload = { barcode_uid: barcodeUid, timeIn, latitude, longitude };

            try {
                const data = await apiFetch('/mark/barcode', 'POST', payload);
                showNotification(data.message, 'success');
                form.reset();
                // Persist GPS data for quick successive scans
                document.getElementById('barcodeLat').value = latitude; 
                document.getElementById('barcodeLon').value = longitude;
                fetchAttendanceSummary();
            } catch (error) {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });

        // --- 4. CONFIGURATION LOGIC ---
        
        async function fetchAttendanceConfig() {
            try {
                const data = await apiFetch('/config');
                const settings = data.settings;
                const payrollRules = data.payrollRules;

                // I. Timing Settings
                document.getElementById('startTime').value = settings.school_start_time || '08:00';
                document.getElementById('lateThreshold').value = settings.late_threshold_minutes || 10;
                document.getElementById('autoMarkAbsentEnabled').checked = settings.auto_mark_absent || false;
                
                // II. Geofence Settings and Flexible Locations
                document.getElementById('geofenceEnabled').checked = settings.geofence_enabled || false;
                document.getElementById('geofenceRadius').value = settings.geofence_radius_meters || 100;
                
                // Default Location 1 (Main Geofence Center)
                document.getElementById('geofenceLat').value = settings.geofence_center_lat || '13.0827';
                document.getElementById('geofenceLon').value = settings.geofence_center_lon || '80.2707';

                // Load custom locations or use mock defaults for display
                const customLocations = JSON.parse(settings.custom_locations || '[]');
                
                const locs = [
                    { id: 1, name: settings.loc1_name || 'Main Campus', lat: settings.geofence_center_lat, lon: settings.geofence_center_lon },
                    { id: 2, name: settings.loc2_name || 'Sports Ground', lat: settings.loc2_lat || '', lon: settings.loc2_lon || '' },
                    { id: 3, name: settings.loc3_name || 'Auditorium', lat: settings.loc3_lat || '', lon: settings.loc3_lon || '' },
                ];
                
                // Set default/loaded values for config form
                document.getElementById('loc1Name').value = locs[0].name;
                document.getElementById('geofenceLat').value = locs[0].lat;
                document.getElementById('geofenceLon').value = locs[0].lon;
                
                document.getElementById('loc2Name').value = locs[1].name;
                document.getElementById('loc2Lat').value = locs[1].lat;
                document.getElementById('loc2Lon').value = locs[1].lon;

                document.getElementById('loc3Name').value = locs[2].name;
                document.getElementById('loc3Lat').value = locs[2].lat;
                document.getElementById('loc3Lon').value = locs[2].lon;

                globalLocations = locs.filter(l => l.lat && l.lon);
                populateTeacherLocations(); // Update teacher check-in form

                // III. Payroll Rules
                document.getElementById('maxLate').value = payrollRules.max_late_entries || 6;
                document.getElementById('lateToPerm').value = payrollRules.late_to_perm_conversion || 6;
                document.getElementById('permToHalf').value = payrollRules.perm_to_halfday_conversion || 8;

            } catch (error) {
                // Fail silently or show default values if API fails/is mocked
                console.error("Failed to fetch config:", error);
            }
        }
        
        document.getElementById('attendanceConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveConfigBtn');
            btn.disabled = true;
            
            // Payload for both attendance_settings and teacher_leave_config
            const payload = {
                startTime: form.startTime.value,
                lateThreshold: parseInt(form.lateThreshold.value),
                autoMarkAbsentEnabled: form.autoMarkAbsentEnabled.checked,
                geofenceEnabled: form.geofenceEnabled.checked,
                geofenceLat: form.geofenceLat.value, // Location 1 GPS (Main Geofence Center)
                geofenceLon: form.geofenceLon.value,
                geofenceRadius: parseInt(form.geofenceRadius.value),
                
                // New Flexible Locations data to be processed by backend
                loc1Name: form.loc1Name.value,
                loc2Name: form.loc2Name.value,
                loc2Lat: form.loc2Lat.value,
                loc2Lon: form.loc2Lon.value,
                loc3Name: form.loc3Name.value,
                loc3Lat: form.loc3Lat.value,
                loc3Lon: form.loc3Lon.value,

                // Payroll Rules
                maxLate: parseInt(form.maxLate.value),
                lateToPerm: parseInt(form.lateToPerm.value),
                permToHalf: parseInt(form.permToHalf.value),
            };

            try {
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message, 'success');
                fetchAttendanceConfig(); // Refresh config display and update globalLocations
            } catch (error) {
                // Error handled by apiFetch
            } finally {
                btn.disabled = false;
            }
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('manualDate').value = today;
            document.getElementById('teacherDate').value = today;
            document.getElementById('manualTimeIn').value = time;
            document.getElementById('teacherTimeIn').value = time;
            document.getElementById('barcodeTimeIn').value = time;
            
            // Add GPS capture event for the student marking tab (Teacher/Admin device location)
            document.getElementById('getCurrentLocationBtn').addEventListener('click', () => {
                getCurrentLocation(document.getElementById('barcodeLat'), document.getElementById('barcodeLon'));
            });

            fetchAttendanceSummary();
            fetchAttendanceConfig();
        });
    </script>
</body>
</html>
