<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’° Enterprise Fee Management System</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .container-fluid { max-width: 1300px; margin-top: 20px; }
        .header-bar {
            background-color: #004d40; /* Darker teal for contrast */
            padding: 10px 20px;
            border-radius: 0.5rem;
            margin-bottom: 20px;
            color: white;
        }
        .card-header { background-color: #00897b; color: white; font-weight: bold; border-radius: 0.5rem 0.5rem 0 0; }
        .section-card { margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .alert-fixed { position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px; border-radius: 0.5rem; }
        .nav-tabs .nav-link.active { background-color: #00897b; color: white; border-color: #00897b; }
        .tab-content { border-radius: 0 0 0.5rem 0.5rem; }
        .overdue-row { background-color: #fce4ec; }
        .text-end { text-align: right !important; }
    </style>
</head>
<body>

    <div class="container-fluid">
        
        <!-- GLOBAL HEADER BAR (Multi-Branch Selector) -->
        <div class="header-bar d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0"><i class="bi bi-bank"></i> Central Accounts Dashboard</h1>
            
            <div class="d-flex align-items-center">
                <label for="branchSelector" class="me-3 mb-0 fw-bold">Active Branch:</label>
                <select id="branchSelector" class="form-select form-select-sm" style="width: 250px;"></select>
                <h5 class="ms-4 mb-0"><span id="currentBranchName" class="badge bg-light text-dark">Loading...</span></h5>
            </div>
        </div>
        
        <!-- Notification Area -->
        <div id="notification-area" class="alert-fixed" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="feeTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="collection-tab" data-bs-toggle="tab" data-bs-target="#collection" type="button"><i class="bi bi-wallet2"></i> Payment Collection</button></li>
            <li class="nav-item"><button class="nav-link" id="defaulters-tab" data-bs-toggle="tab" data-bs-target="#defaulters" type="button"><i class="bi bi-person-x-fill"></i> Defaulters & Alerts</button></li>
            <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"><i class="bi bi-sliders"></i> Configuration & Rules</button></li>
            <li class="nav-item"><button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button"><i class="bi bi-building-check"></i> Accounting & Integration</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content pt-3" id="feeTabContent">

            <!-- 1. Payment Collection Tab (POST /payment) -->
            <div class="tab-pane fade show active" id="collection" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-success">Log New Payment & Verification</div>
                    <div class="card-body">
                        
                        <!-- Payment Logging Form -->
                        <form id="paymentForm" class="row g-3 mb-4">
                            <h5 class="text-primary">Record New Transaction (Branch: <span class="text-danger" id="formBranchName"></span>)</h5>
                            <div class="col-md-4">
                                <label for="studentId" class="form-label">Student ID (UUID)</label>
                                <input type="text" class="form-control" id="studentId" placeholder="e.g., uuid-std-123" required>
                            </div>
                            <div class="col-md-4">
                                <label for="amountPaid" class="form-label">Amount Paid (â‚¹)</label>
                                <input type="number" class="form-control" id="amountPaid" min="1" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label for="feeStructureId" class="form-label">Fee Structure ID (Optional)</label>
                                <input type="text" class="form-control" id="feeStructureId" placeholder="e.g., Q1-2025" >
                            </div>
                            <div class="col-md-4">
                                <label for="paymentMethod" class="form-label">Method</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="cash">Cash</option>
                                    <option value="online">Online Transfer/UPI</option>
                                    <option value="card">Card</option>
                                    <option value="cheque">Cheque</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="transactionId" class="form-label">Transaction/Reference ID</label>
                                <input type="text" class="form-control" id="transactionId" placeholder="Required for non-cash methods">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100" id="logPaymentBtn"><i class="bi bi-plus-circle"></i> Log Payment</button>
                            </div>
                        </form>

                        <hr>
                        
                        <!-- Payment History & Verification -->
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="text-primary mt-3">Recent Payments Logged</h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-info mt-3" id="triPartyBtn" data-bs-toggle="modal" data-bs-target="#verificationModal"><i class="bi bi-whatsapp"></i> Initiate Tri-Party Verification</button>
                            </div>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student Name</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Txn ID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <tr><td colspan="6" class="text-center">Select a branch to view payments.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="paymentPagination" class="d-flex justify-content-center">
                            <button class="btn btn-sm btn-outline-primary me-2" id="prevPaymentBtn" disabled>Prev</button>
                            <button class="btn btn-sm btn-outline-primary" id="nextPaymentBtn" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Defaulters & Alerts Tab (GET /defaulters, POST /defaulters/auto-alert) -->
            <div class="tab-pane fade" id="defaulters" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-danger">Defaulters Management & Automated Alerts</div>
                    <div class="card-body">
                        
                        <!-- Defaulter Filters & Actions -->
                        <form id="defaulterFilterForm" class="row g-3 mb-4">
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="minOverdueDays" placeholder="Min Overdue Days" min="1">
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="minAmount" placeholder="Min Overdue Amount (â‚¹)" min="100">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-danger w-100"><i class="bi bi-filter-circle"></i> Filter Defaulters</button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-warning w-100" id="sendAlertsBtn"><i class="bi bi-bell"></i> Send Daily Reminders</button>
                            </div>
                        </form>

                        <!-- Defaulters List -->
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Overdue Amount</th>
                                        <th>Days Overdue</th>
                                        <th>Parent Phone</th>
                                        <th>Last Alert</th>
                                    </tr>
                                </thead>
                                <tbody id="defaultersTableBody">
                                    <tr><td colspan="6" class="text-center">Select a branch to view defaulters.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-sm btn-outline-secondary" id="exportDefaultersCsv"><i class="bi bi-file-earmark-spreadsheet"></i> Export CSV</button>
                            <button class="btn btn-sm btn-outline-secondary" id="exportDefaultersPdf"><i class="bi bi-file-earmark-pdf"></i> Export PDF Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Configuration & Rules Tab (GET/PUT /config) -->
            <div class="tab-pane fade" id="config" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-info">Fee Configuration, Late Rules & Structures (Branch: <span id="configBranchName"></span>)</div>
                    <div class="card-body">
                        
                        <form id="configForm" class="row g-3">
                            <h5 class="text-info"><i class="bi bi-wrench"></i> Core Fee Rules</h5>
                            <div class="col-md-4">
                                <label for="lateFeePercent" class="form-label">Late Fee Percentage (%)</label>
                                <input type="number" class="form-control" id="lateFeePercent" min="0" max="100" step="0.1" required>
                                <div class="form-text">Percentage applied to the outstanding balance after the grace period.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="graceDays" class="form-label">Grace Period (Days)</label>
                                <input type="number" class="form-control" id="graceDays" min="0" required>
                                <div class="form-text">Number of days after the due date before late fees start accruing.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="accountingSyncEnabled" class="form-label">Tally/Accounting Sync</label>
                                <select class="form-select" id="accountingSyncEnabled">
                                    <option value="true">Enabled (Auto Sync)</option>
                                    <option value="false">Disabled (Manual Sync Only)</option>
                                </select>
                                <div class="form-text">Controls automated fee data synchronization with external accounting software.</div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5 class="text-info"><i class="bi bi-list-columns-reverse"></i> Fee Structure Management</h5>
                            <p class="small text-muted">Use the form to add new components (like Transportation, Olympiad, etc.) or remove existing ones below.</p>
                            
                            <!-- New form for adding components -->
                            <form id="addFeeComponentForm" class="row g-3 mb-4 p-3 border rounded bg-light">
                                <div class="col-md-3">
                                    <label class="form-label small">Component Name</label>
                                    <input type="text" class="form-control form-control-sm" id="newComponentName" placeholder="e.g., Annual Day Fee" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Class Range</label>
                                    <input type="text" class="form-control form-control-sm" id="newClassRange" placeholder="e.g., 9th-12th" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Amount (â‚¹)</label>
                                    <input type="number" class="form-control form-control-sm" id="newAmount" min="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Applicability</label>
                                    <select class="form-select form-select-sm" id="newApplicability">
                                        <option value="Mandatory">Mandatory</option>
                                        <option value="Optional">Optional</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-sm btn-outline-success w-100"><i class="bi bi-plus-lg"></i> Add Component</button>
                                </div>
                            </form>

                            <!-- Fee Structure Table -->
                            <div class="col-12 table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead>
                                        <tr><th>Component</th><th>Class Range</th><th>Amount (â‚¹)</th><th>Applicability</th><th>Action</th></tr>
                                    </thead>
                                    <tbody id="feeStructureBody">
                                        <tr><td colspan="5" class="text-center">Select a branch to manage fee structure.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-info btn-lg w-100" id="saveConfigBtn"><i class="bi bi-save"></i> Save All Configuration Rules</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 4. Accounting & Integration Tab (POST /tally/sync-collection, POST /tally/webhook) -->
            <div class="tab-pane fade" id="audit" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header bg-dark">Accounting & Tally Integration (Branch: <span id="auditBranchName"></span>)</div>
                    <div class="card-body">

                        <h5 class="text-danger"><i class="bi bi-tally"></i> Tally Accounting Sync</h5>
                        <p class="text-muted">Initiate manual synchronization of fee collections to Tally for reconciliation.</p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" id="tallySyncBtn"><i class="bi bi-arrow-repeat"></i> Sync Fee Collection to Tally Now</button>
                                <div class="form-text mt-2" id="tallyStatus">Last sync: Never.</div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-secondary w-100" disabled><i class="bi bi-journal-text"></i> View Tally Sync Audit Log</button>
                                <div class="form-text mt-2">Check detailed success/failure log for reconciliation status.</div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-danger"><i class="bi bi-life-preserver"></i> Automated Reconciliation Response</h5>
                        <p class="small text-success fw-bold">This system automatically handles success, failure, and overpayment from Tally:</p>
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item text-success"><i class="bi bi-check-circle-fill"></i> **Success:** Logs confirmation.</li>
                            <li class="list-group-item text-warning"><i class="bi bi-exclamation-triangle-fill"></i> **Failure:** Instantly sends parent a new **Payment Link** to resolve the issue.</li>
                            <li class="list-group-item text-info"><i class="bi bi-cash-stack"></i> **Overpayment:** Instantly sends parent confirmation: "Your excess amount (â‚¹X.XX) will be refunded within 1-2 business days."</li>
                        </ul>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Tri-Party Verification Modal (POST /verification/triparty-initiate) -->
    <div class="modal fade" id="verificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title"><i class="bi bi-patch-check"></i> Tri-Party Verification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="verificationForm">
                    <div class="modal-body">
                        <p class="text-muted small">Select a payment ID to initiate a confirmation request to the paying parent via Arattai/WhatsApp.</p>
                        <div class="mb-3">
                            <label for="verificationPaymentId" class="form-label">Payment ID to Verify</label>
                            <input type="text" class="form-control" id="verificationPaymentId" placeholder="e.g., payment_uuid_123" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-info" id="initiateVerificationBtn"><i class="bi bi-send"></i> Initiate Verification</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = ''; 
        const MOCK_JWT_TOKEN = 'mock.jwt.token.for.auth';
        let currentPaymentPage = 1;
        const paymentPageSize = 50;
        let currentDefaulterPage = 1;
        const defaulterPageSize = 50;
        
        // --- MULTI-BRANCH MOCK DATA AND STATE ---
        const mockBranches = [
            { id: '00000000-0000-0000-0000-000000000001', name: 'HQ - Chennai Main' },
            { id: 'BRANCH-002', name: 'Branch 2 - Velachery' },
            { id: 'BRANCH-003', name: 'Branch 3 - Anna Nagar' },
            { id: 'BRANCH-004', name: 'Branch 4 - T. Nagar' },
            { id: 'BRANCH-005', name: 'Branch 5 - Coimbatore' },
            { id: 'BRANCH-006', name: 'Branch 6 - Madurai' },
            { id: 'BRANCH-007', name: 'Branch 7 - Trichy' },
            { id: 'BRANCH-008', name: 'Branch 8 - Salem' },
            { id: 'BRANCH-009', name: 'Branch 9 - Erode' },
            { id: 'BRANCH-010', name: 'Branch 10 - Tirunelveli' }
        ];
        let currentSchoolId = mockBranches[0].id;
        
        // Mock Fee Structures (Simulate different structures per branch)
        const branchFeeStructures = {
            '00000000-0000-0000-0000-000000000001': [
                { name: 'Tuition - Annual', range: 'All', amount: 55000, applicability: 'Mandatory' },
                { name: 'Transport - Qtr', range: 'All', amount: 15000, applicability: 'Optional' },
            ],
            'BRANCH-002': [
                { name: 'Tuition - Half Year', range: 'All', amount: 28000, applicability: 'Mandatory' },
                { name: 'Exam Fee', range: 'All', amount: 1500, applicability: 'Mandatory' },
            ],
            // Default structure for other branches
            default: [
                { name: 'Tuition', range: 'All', amount: 45000, applicability: 'Mandatory' },
                { name: 'Olympiad Fee', range: '9th-12th', amount: 500, applicability: 'Optional' },
            ]
        };


        /** Helper function to show a temporary notification. */
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            area.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            area.style.display = 'block';
            setTimeout(() => { area.style.display = 'none'; }, 7000);
        }

        /** Core Fetch Function with JWT Auth Header and Branch Filter. */
        async function apiFetch(endpoint, method = 'GET', body = null) {
            let url = `${API_BASE}${endpoint}`;
            
            // Append schoolId filter for multi-branch operation
            const sep = url.includes('?') ? '&' : '?';
            url += `${sep}schoolId=${currentSchoolId}`;

            try {
                const options = {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MOCK_JWT_TOKEN}` 
                    },
                };
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `API error (${response.status})`);
                }
                return data;

            } catch (error) {
                console.error('API Fetch Error:', endpoint, error);
                showNotification(error.message || 'Network error. Check console for details.', 'danger');
                throw error;
            }
        }
        
        // --- GLOBAL BRANCH HANDLER ---
        function updateUIForBranch(branchId) {
            const branch = mockBranches.find(b => b.id === branchId) || mockBranches[0];
            const branchName = branch.name;

            document.getElementById('currentBranchName').textContent = branchName;
            document.getElementById('formBranchName').textContent = branchName;
            document.getElementById('configBranchName').textContent = branchName;
            document.getElementById('auditBranchName').textContent = branchName;
        }

        async function handleBranchChange(event) {
            const newBranchId = event.target.value;
            currentSchoolId = newBranchId;
            updateUIForBranch(newBranchId);
            showNotification(`Switching to ${mockBranches.find(b => b.id === newBranchId).name}. Reloading data...`, 'secondary');

            // Reload all operational tabs' data
            await fetchConfig();
            await fetchPayments(1);
            await fetchDefaulters();
        }

        function initBranchSelector() {
            const selector = document.getElementById('branchSelector');
            mockBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                selector.appendChild(option);
            });
            
            selector.value = currentSchoolId;
            updateUIForBranch(currentSchoolId);
            selector.addEventListener('change', handleBranchChange);
        }


        // --- FEE STRUCTURE DYNAMIC MANAGEMENT (Updated to be branch-aware) ---

        function addFeeComponentToTable(component) {
            const tableBody = document.getElementById('feeStructureBody');
            const row = tableBody.insertRow();
            
            row.setAttribute('data-component', component.name); 
            const cleanAmount = parseFloat(component.amount).toFixed(2);
            
            row.innerHTML = `
                <td data-field="name">${component.name}</td>
                <td data-field="range">${component.range}</td>
                <td data-field="amount" class="text-end" data-raw-amount="${cleanAmount}">â‚¹${parseFloat(cleanAmount).toLocaleString('en-IN')}</td>
                <td data-field="applicability">${component.applicability}</td>
                <td><button type="button" class="btn btn-sm btn-outline-danger delete-fee-component">Del</button></td>
            `;

            // Add event listener for the delete button
            row.querySelector('.delete-fee-component').addEventListener('click', (e) => {
                const componentName = e.target.closest('tr').getAttribute('data-component');
                if (confirm(`Are you sure you want to remove the component: ${componentName}?`)) {
                    e.target.closest('tr').remove();
                    showNotification(`Fee component "${componentName}" removed from table. Click Save to finalize.`, 'warning');
                }
            });
        }
        
        function loadFeeStructureForBranch(branchId) {
            const tableBody = document.getElementById('feeStructureBody');
            tableBody.innerHTML = ''; 
            
            // Mock fetching the correct structure based on branchId
            const structure = branchFeeStructures[branchId] || branchFeeStructures.default;

            if (structure.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No fee structure defined for this branch. Add new components above.</td></tr>';
            } else {
                structure.forEach(addFeeComponentToTable);
            }
        }

        document.getElementById('addFeeComponentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            
            const newComponent = {
                name: form.newComponentName.value.trim(),
                range: form.newClassRange.value.trim(),
                amount: parseFloat(form.newAmount.value),
                applicability: form.newApplicability.value
            };
            
            if (newComponent.name && newComponent.range && !isNaN(newComponent.amount) && newComponent.amount >= 0) {
                addFeeComponentToTable(newComponent);
                showNotification(`Component "${newComponent.name}" added successfully.`, 'success');
                form.reset();
            } else {
                showNotification('Please fill in all required fields correctly (Amount must be a non-negative number).', 'danger');
            }
        });

        function harvestFeeStructureData() {
            const rows = document.querySelectorAll('#feeStructureBody tr');
            const updates = [];
            rows.forEach(row => {
                const rawAmountElement = row.querySelector('[data-raw-amount]');
                if (rawAmountElement) {
                    updates.push({
                        name: row.querySelector('[data-field="name"]').textContent,
                        classRange: row.querySelector('[data-field="range"]').textContent,
                        amount: parseFloat(rawAmountElement.getAttribute('data-raw-amount')),
                        applicability: row.querySelector('[data-field="applicability"]').textContent,
                    });
                }
            });
            return updates;
        }


        // --- 1. PAYMENT COLLECTION LOGIC (Updated to be branch-aware) ---

        async function fetchPayments(page = 1) {
            currentPaymentPage = page;
            const offset = (page - 1) * paymentPageSize;
            const tableBody = document.getElementById('paymentsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading payments for ' + currentSchoolId + '...</td></tr>';
            
            try {
                // API call now automatically sends the currentSchoolId as a query parameter
                const data = await apiFetch(`/payments?limit=${paymentPageSize}&offset=${offset}`);
                
                tableBody.innerHTML = '';
                if (data.payments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No payment records found for this branch.</td></tr>';
                    document.getElementById('nextPaymentBtn').disabled = true;
                    document.getElementById('prevPaymentBtn').disabled = true;
                    return;
                }
                
                // MOCKING: Filtering mock data based on schoolId is assumed to happen on the backend
                
                data.payments.forEach(p => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(p.payment_date).toLocaleDateString()}</td>
                        <td>${p.first_name || 'N/A'} ${p.last_name || ''}</td>
                        <td>â‚¹${p.amount_paid.toFixed(2)}</td>
                        <td>${p.payment_method}</td>
                        <td class="small">${p.transaction_id || 'CASH'}</td>
                        <td><span class="badge bg-success">RECONCILED</span></td>
                    `;
                });

                document.getElementById('prevPaymentBtn').disabled = currentPaymentPage === 1;
                document.getElementById('nextPaymentBtn').disabled = data.payments.length < paymentPageSize;

            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load payments. API Error.</td></tr>';
            }
        }


        // --- 2. DEFAULTERS LOGIC (Updated to be branch-aware) ---

        async function fetchDefaulters() {
            const tableBody = document.getElementById('defaultersTableBody');
            const minOverdueDays = document.getElementById('minOverdueDays').value;
            const minAmount = document.getElementById('minAmount').value;
            
            let query = `/defaulters?limit=${defaulterPageSize}`;
            if (minOverdueDays) query += `&minOverdueDays=${minOverdueDays}`;
            if (minAmount) query += `&minAmount=${minAmount}`;

            tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading defaulters for ' + currentSchoolId + '...</td></tr>';
            
            try {
                // API call now automatically sends the currentSchoolId as a query parameter
                const data = await apiFetch(query);
                
                tableBody.innerHTML = '';
                if (data.defaulterList.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No defaulters found for this branch.</td></tr>';
                    return;
                }

                // MOCKING: Assuming backend filters by schoolId
                
                data.defaulterList.forEach(d => {
                    const row = tableBody.insertRow();
                    row.classList.add('overdue-row');
                    row.innerHTML = `
                        <td>${d.student_name || 'Mock Student'}</td>
                        <td>${d.class_name || 'X-A'}</td>
                        <td class="fw-bold">â‚¹${(d.amount || 25000).toFixed(2)}</td>
                        <td>${d.days_overdue || '30'}</td>
                        <td>${d.parent_phone || '+91...'}</td>
                        <td>${d.last_alert_date || 'N/A'}</td>
                    `;
                });

            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load defaulters. API Error.</td></tr>';
            }
        }
        

        // --- 3. CONFIGURATION LOGIC (Updated to be branch-aware) ---

        async function fetchConfig() {
            try {
                // API call now automatically sends the currentSchoolId as a query parameter
                const data = await apiFetch('/config');
                const config = data.config;
                
                document.getElementById('lateFeePercent').value = config.lateFeePercent || 2.0;
                document.getElementById('graceDays').value = config.graceDays || 15;
                document.getElementById('accountingSyncEnabled').value = String(config.accountingSyncEnabled || true);
                
                // Load the fee structure specific to the current branch
                loadFeeStructureForBranch(currentSchoolId);

                showNotification(`Configuration for ${document.getElementById('currentBranchName').textContent} loaded successfully.`, 'secondary');
            } catch (error) {
                console.warn('Could not load configuration. Using defaults.');
                loadFeeStructureForBranch(currentSchoolId); // Load mock structure if API fails
            }
        }

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('saveConfigBtn');
            
            const feeStructureUpdates = harvestFeeStructureData();

            const payload = {
                lateFeePercent: parseFloat(form.lateFeePercent.value),
                graceDays: parseInt(form.graceDays.value, 10),
                accountingSyncEnabled: form.accountingSyncEnabled.value === 'true',
                feeStructureUpdates: feeStructureUpdates, 
                discountUpdates: [{ name: 'Sibling', value: 10 }]
            };
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            try {
                // PUT request implicitly targets the current schoolId via apiFetch
                const data = await apiFetch('/config', 'PUT', payload);
                showNotification(data.message + ` (${feeStructureUpdates.length} components saved for ${document.getElementById('currentBranchName').textContent}!)`, 'success');
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save"></i> Save All Configuration Rules';
            }
        });

        // --- 4. TALLY & VERIFICATION LOGIC (Updated to be branch-aware) ---

        document.getElementById('tallySyncBtn').addEventListener('click', async () => {
            const btn = document.getElementById('tallySyncBtn');
            const statusDiv = document.getElementById('tallyStatus');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initiating Sync...';
            statusDiv.textContent = 'Initiating sync with Tally... (Backend will handle auto-fail/refund notifications)';

            try {
                // API call now automatically sends the currentSchoolId as a query parameter
                const data = await apiFetch('/tally/sync-collection', 'POST', {});
                
                showNotification(data.message + ` (Branch: ${document.getElementById('currentBranchName').textContent})`, 'success');
                statusDiv.textContent = `Sync initiated at: ${new Date().toLocaleTimeString()}. Status: ${data.status.toUpperCase()}`;
            } catch (error) {
                statusDiv.textContent = 'Sync failed. Check API error.';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync Fee Collection to Tally Now';
            }
        });

        // --- PAYMENT LOGGING ---

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('logPaymentBtn');

            const payload = {
                studentId: form.studentId.value,
                amount: parseFloat(form.amountPaid.value),
                method: form.paymentMethod.value,
                transactionId: form.transactionId.value,
                feeStructureId: form.feeStructureId.value,
                // schoolId is automatically added by apiFetch
            };

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const data = await apiFetch('/payment', 'POST', payload);
                showNotification(data.message + ` Payment ID: ${data.paymentId}`, 'success');
                form.reset();
                fetchPayments(1); // Refresh list
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-plus-circle"></i> Log Payment';
            }
        });

        // --- TRI-PARTY VERIFICATION ---

        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('initiateVerificationBtn');
            const paymentId = form.verificationPaymentId.value;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initiating...';
            
            try {
                const data = await apiFetch('/verification/triparty-initiate', 'POST', { paymentId });
                showNotification(data.message, 'info');
                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('verificationModal')).hide();
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send"></i> Initiate Verification';
            }
        });

        // --- DEFAULTER EXPORTS ---

        async function handleDefaulterExport(format) {
            const btn = document.getElementById(`exportDefaulters${format === 'csv' ? 'Csv' : 'Pdf'}`);
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Generating...`;

            try {
                const response = await apiFetch(`/defaulters?export=${format}`, 'GET');
                
                if (format === 'csv') {
                    // In a real browser environment, the backend would stream the file.
                    // Here we simulate the download link message.
                    showNotification('CSV generation initiated. File download should start shortly.', 'success');
                } else {
                    showNotification(response.message || 'PDF report generation queued successfully.', 'success');
                }
            } catch (error) {
                // Handled by apiFetch
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initBranchSelector(); // Initialize the multi-branch logic first
            // Initial data loads triggered by the branch handler

            // Set up pagination buttons
            document.getElementById('prevPaymentBtn').addEventListener('click', () => { if (currentPaymentPage > 1) fetchPayments(currentPaymentPage - 1); });
            document.getElementById('nextPaymentBtn').addEventListener('click', () => { fetchPayments(currentPaymentPage + 1); });
            document.getElementById('defaulterFilterForm').addEventListener('submit', (e) => { e.preventDefault(); fetchDefaulters(); });

            // Set up export buttons
            document.getElementById('exportDefaultersCsv').addEventListener('click', () => handleDefaulterExport('csv'));
            document.getElementById('exportDefaultersPdf').addEventListener('click', () => handleDefaulterExport('pdf'));
            
            // Set up automated alert button
            document.getElementById('sendAlertsBtn').addEventListener('click', async () => {
                const confirmAlert = confirm("Are you sure you want to trigger automated daily reminders to all filtered defaulters now?");
                if (!confirmAlert) return;
                
                const btn = document.getElementById('sendAlertsBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

                try {
                    const data = await apiFetch('/defaulters/auto-alert', 'POST', {});
                    showNotification(data.message, 'success');
                } catch (error) {
                    // Handled by apiFetch
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-bell"></i> Send Daily Reminders';
                }
            });

        });
    </script>
</body>
</html>
